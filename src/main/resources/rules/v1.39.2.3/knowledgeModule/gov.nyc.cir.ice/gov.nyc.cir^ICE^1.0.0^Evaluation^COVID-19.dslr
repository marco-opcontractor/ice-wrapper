/**
 * Copyright (C) 2023 New York City Department of Health and Mental Hygiene, Bureau of Immunization
 * Contributions by HLN Consulting, LLC
 *
 * This program is free software: you can redistribute it and/or modify it under the terms of the GNU
 * Lesser General Public License as published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version. You should have received a copy of the GNU Lesser
 * General Public License along with this program. If not, see <http://www.gnu.org/licenses/> for more
 * details.
 *
 * The above-named contributors (HLN Consulting, LLC) are also licensed by the New York City
 * Department of Health and Mental Hygiene, Bureau of Immunization to have (without restriction,
 * limitation, and warranty) complete irrevocable access and rights to this project.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; THE
 *
 * SOFTWARE IS PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING,
 * BUT NOT LIMITED TO, WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE COPYRIGHT HOLDERS, IF ANY, OR DEVELOPERS BE LIABLE FOR
 * ANY CLAIM, DAMAGES, OR OTHER LIABILITY OF ANY KIND, ARISING FROM, OUT OF, OR IN CONNECTION WITH
 * THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 *
 * For more information about this software, see http://www.hln.com/ice or send
 * correspondence to ice@hln.com.
 */

package knowledgeModule.gov.nyc.cir.ice

import java.util.List
import java.util.Set
import org.opencds.vmr.v1_0.internal.EvalTime
import org.opencds.vmr.v1_0.internal.EvaluatedPerson
import org.cdsframework.ice.service.DiseaseImmunity
import org.cdsframework.ice.service.DoseRule
import org.cdsframework.ice.service.DoseStatus
import org.cdsframework.ice.service.ICEFactTypeFinding
import org.cdsframework.ice.service.ICELogicHelper
import org.cdsframework.ice.service.RecommendationStatus
import org.cdsframework.ice.service.SeriesRules
import org.cdsframework.ice.supportingdatatmp.SupportedFactConcept
import org.cdsframework.ice.service.TargetDose
import org.cdsframework.ice.service.TargetSeries
import org.cdsframework.ice.util.TimePeriod
import org.cdsframework.ice.util.TimePeriod.DurationType
import org.cdsframework.ice.service.Vaccine

expander ../../knowledgeCommon/org.cdsframework.ice/org.cdsframework^ICE^1.0.0.dsl

global java.util.Date evalTime


//////////////////////////////////////////////////////////////////////////////////////////////////
// Evaluation of vaccines not authorized by the FDA or WHO
// If the patient has received a COVID-19 vaccine not authorized by the FDA or WHO, then evaluate the shot as Invalid/VACCINE_NOT_APPROVED_IN_US_OR_BY_WHO
//////////////////////////////////////////////////////////////////////////////////////////////////

rule "COVID-19: If the vaccine administered is authorized neither by the FDA nor WHO, evaluate the shot as INVALID/VACCINE_NOT_APPROVED_IN_US_OR_BY_WHO"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	activation-group "allowableVaccineCheck"
	when
		There is an administered shot $currentShot that needs to be evaluated
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the vaccine administered a member of ("ICE500", "ICE501", "ICE503", "ICE504", "ICE505", "ICE506", "ICE507", "ICE508", "ICE509", "ICE513", "ICE514", "ICE515", "ICE516", "ICE517", "ICE518", "ICE521")
			- make note of the associated series as $targetSeries
	then
		Include the reason for shot $currentShot Invalid due to "Vaccine Not Approved for Use in the U.S. or by the WHO"
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $targetSeries
end


//////////////////////////////////////////////////////////////////////////////////////////////////
// START ACCEPTED vaccines in a wrong FDA-approved series
// FDA-approved or WHO-approved vaccines in the wrong FDA-approved series that is not complete always get evaluated as ACCEPTED/VACCINE_NOT_COUNTED_BASED_ON_MOST_RECENT_VACCINE_GIVEN rather than Invalid.
//////////////////////////////////////////////////////////////////////////////////////////////////

rule "COVID-19: If an FDA-approved, NOS or WHO-approved vaccine, the vaccine is not permitted be default for the series and there are no other shots following it, and the series is not complete, evaluate it as ACCEPTED/VACCINE_NOT_COUNTED_BASED_ON_MOST_RECENT_VACCINE_GIVEN"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	activation-group "allowableVaccineCheck"
	when
		There is an administered shot $currentShot that needs to be evaluated
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the vaccine administered a member of ("ICE207", "ICE208", "ICE210", "ICE211", "ICE213", "ICE217", "ICE218", "ICE219", "ICE221", "ICE227", "ICE228", "ICE229", "ICE300", "ICE301", "ICE302", "ICE308", "ICE309", "ICE310", "ICE311", "ICE312", "ICE313", "ICE502", "ICE510", "ICE511", "ICE512", "ICE519", "ICE520")
			- the series that the shot belongs to is not complete
			- make note of the administered vaccine as $vaccineAdministered
			- make note of the dose number as $doseNumber
			- make note of the associated series as $associatedTargetSeries
		There is a Series $targetSeries identified by $associatedTargetSeries
			- the vaccine $vaccineAdministered is not permitted for dose number $doseNumber in this series
		There exists another administered shot
			- the shot belongs to the series $targetSeries
			- that has not already been evaluated
	then
		Include the reason for shot $currentShot Accepted due to "Vaccine Not Counted Based on Most Recent Vaccine Given"
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $targetSeries
end

//////////////////////////////////////////////////////////////////////////////////////////////////
// END ACCEPTED vaccines in a wrong FDA-approved series
//////////////////////////////////////////////////////////////////////////////////////////////////


//////////////////////////////////////////////////////////////////////////////////////////////////
// START INVALID vaccines specified prior to availability datein a wrong FDA-approved series
//////////////////////////////////////////////////////////////////////////////////////////////////

rule "COVID-19: If a bivalent vaccine was administered prior to 9/2/2022, evaluate the shot as Invalid / VACCINE_NOT_YET_AVAILABLE_ON_DATE_SPECIFIED"
	dialect "mvel"
	agenda-group "HistoryEvaluation^postEvaluationCheck"
	no-loop true
	when
		There is an administered shot $currentShot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- that has already been evaluated
			- the administration date of the shot is < "02-Sep-2022"
			- the vaccine administered a member of ("ICE229", "ICE230", "ICE300", "ICE301", "ICE302", "ICE519", "ICE520")
			- make note of all evaluation reasons for this shot as $oEvaluationReasons
			- the collection $oEvaluationReasons does not contain "EVALUATION_REASON_CONCEPT.EXTRA_DOSE"
			- the collection $oEvaluationReasons does not contain "EVALUATION_REASON_CONCEPT.VACCINE_NOT_YET_AVAILABLE_ON_DATE_SPECIFIED"
			- make note of the associated series as $associatedTargetSeries
	then
		Set the shot status of $currentShot to Invalid
		Remove all evaluation reasons from shot $currentShot
		Include the reason for shot $currentShot Invalid due to "Vaccine Not Yet Available for Use on Specified Administration Date"
		Refresh all facts in the shot $currentShot
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end

rule "COVID-19: If a 2023/2024 vaccine was administered prior to 9/12/2023, evaluate the shot as Invalid / VACCINE_NOT_YET_AVAILABLE_ON_DATE_SPECIFIED"
	dialect "mvel"
	agenda-group "HistoryEvaluation^postEvaluationCheck"
	no-loop true
	when
		There is an administered shot $currentShot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- that has already been evaluated
			- the administration date of the shot is < "12-Sep-2023"
			- the vaccine administered a member of ("ICE308", "ICE309", "ICE310", "ICE311", "ICE312")
			- make note of all evaluation reasons for this shot as $oEvaluationReasons
			- the collection $oEvaluationReasons does not contain "EVALUATION_REASON_CONCEPT.EXTRA_DOSE"
            - the collection $oEvaluationReasons does not contain "EVALUATION_REASON_CONCEPT.VACCINE_NOT_YET_AVAILABLE_ON_DATE_SPECIFIED"
			- make note of the associated series as $associatedTargetSeries
	then
		Set the shot status of $currentShot to Invalid
		Remove all evaluation reasons from shot $currentShot
		Include the reason for shot $currentShot Invalid due to "Vaccine Not Yet Available for Use on Specified Administration Date"
		Refresh all facts in the shot $currentShot
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end


rule "COVID-19: If a CVX 313 vaccine was administered prior to 10/04/2023, evaluate the shot as Invalid / VACCINE_NOT_YET_AVAILABLE_ON_DATE_SPECIFIED"
	dialect "mvel"
	agenda-group "HistoryEvaluation^postEvaluationCheck"
	no-loop true
	when
		There is an administered shot $currentShot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- that has already been evaluated
			- the administration date of the shot is < "04-Oct-2023"
			- the vaccine administered a member of ("ICE313")
			- make note of all evaluation reasons for this shot as $oEvaluationReasons
			- the collection $oEvaluationReasons does not contain "EVALUATION_REASON_CONCEPT.EXTRA_DOSE"
      - the collection $oEvaluationReasons does not contain "EVALUATION_REASON_CONCEPT.VACCINE_NOT_YET_AVAILABLE_ON_DATE_SPECIFIED"
			- make note of the associated series as $associatedTargetSeries
	then
		Set the shot status of $currentShot to Invalid
		Remove all evaluation reasons from shot $currentShot
		Include the reason for shot $currentShot Invalid due to "Vaccine Not Yet Available for Use on Specified Administration Date"
		Refresh all facts in the shot $currentShot
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end

//////////////////////////////////////////////////////////////////////////////////////////////////
// END INVALID vaccines specified prior to availability datein a wrong FDA-approved series
//////////////////////////////////////////////////////////////////////////////////////////////////



rule "COVID-19: Remove evaluation reason VACCINE_NOT_ALLOWED_FOR_THIS_DOSE for shots administered before the series is complete (excluding CVX 230 on >= 4/19/2023)"
	dialect "mvel"
	agenda-group "HistoryEvaluation^postEvaluationCheck"
	when
		There is an administered shot $currentShot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- that has already been evaluated and whose shot validity is INVALID or ACCEPTED
			- the Series that the shot belongs to is not complete
			- the vaccine administered not a member of ("ICE230", "ICE211")
			- make note of the administered shot number as $shotNumber
			- make note of the associated series as $associatedTargetSeries
			- make note of the date this shot was administered as $currentShotDate
		There is an IceFact $iceFact
			- that has associated series $associatedTargetSeries
			- that has associated administered shot $currentShot
			- that has finding SupportedFactConcept._INVALID_VACCINE.conceptCodeValue
		There does not exist an administered shot
			- the shot belongs to the Series $associatedTargetSeries
			- that has already been evaluated
			- the administered shot number is > $shotNumber
		Confirm the date evalTime is on the same date or after "19-Apr-2023"
	then
		Remove Evaluation Reason "EVALUATION_REASON_CONCEPT.VACCINE_NOT_ALLOWED_FOR_THIS_DOSE" from Shot $currentShot
		Record that this dose rule was processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end



/*************************************************************************************************************************************************************************************
 START Rules for an Additional Dose and/or Booster Dose in all Series
/************************************************************************************************************************************************************************************/

rule "COVID-19: If the series is complete, override allowable vaccine check, as the allowable vaccines for additional and booster doses are verified by each rule"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	activation-group "allowableVaccineCheck"
	when
		There is an administered shot $currentShot that needs to be evaluated
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the series that the shot belongs to is complete
			- make note of the associated series as $associatedTargetSeries
	then
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end


/*************************************************************************************************
 START < 9/2/2022
/************************************************************************************************/

//////////////////////////////////////////////////////////////////////
// START Pfizer, Moderna, Novavax or Authorized WHO Series Additional/Booster Logic
//////////////////////////////////////////////////////////////////////

rule "COVID-19: If the shot administration date is < 9/2/2022 and at >= 5 yrs and < 18 yrs of age for an Additional Dose is administered in the __Moderna Series__, the shot is permitted"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	activation-group "extraDoseCheck"
	when
		There is an administered shot $currentShot that needs to be evaluated
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the shot belongs to the Series with name "COVID19ModernaSeries"
			- the vaccine administered a member of ("ICE207", "ICE208", "ICE211", "ICE212", "ICE213", "ICE217", "ICE218", "ICE219", "ICE221", "ICE227", "ICE228", "ICE229", "ICE230", "ICE300", "ICE301", "ICE302", "ICE519", "ICE520")
			- make note of the date this shot was administered as $currentShotDate
			- the date $currentShotDate < "02-Sep-2022"
			- make note of the associated series as $associatedTargetSeries
		There is a Series $targetSeries identified by $associatedTargetSeries
			- the series is complete
			- make note of the dose number after which the Series was marked complete as $doseNumberAfterWhichComplete
			- the effective number of doses administered in the Series is < $doseNumberAfterWhichComplete+1
		The patient information $oEvaluatedPersonAbstract must be known to complete writing this rule
			- make note of the date as $dateAt5yOfAge when the patient is "5y" of age
			- make note of the date as $dateAt18yOfAge when the patient is "18y" of age
			- the date $currentShotDate >= $dateAt5yOfAge
			- the date $currentShotDate < $dateAt18yOfAge
	then
		Set the Shot Status of $currentShot to Valid
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $targetSeries
end


rule "COVID-19: If the shot administration date is < 9/2/2022 and at >= 18 yrs and < 50 yrs of age for an Additional Dose and/or 1st Booster Dose is administered in the __Moderna Series__, the shot is permitted"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	activation-group "extraDoseCheck"
	when
		There is an administered shot $currentShot that needs to be evaluated
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the shot belongs to the Series with name "COVID19ModernaSeries"
			- the vaccine administered a member of ("ICE207", "ICE208", "ICE211", "ICE212", "ICE213", "ICE217", "ICE218", "ICE219", "ICE221", "ICE227", "ICE228", "ICE229", "ICE230", "ICE300", "ICE301", "ICE302", "ICE519", "ICE520")
			- make note of the date this shot was administered as $currentShotDate
			- the date $currentShotDate < "02-Sep-2022"
			- make note of the associated series as $associatedTargetSeries
		There is a Series $targetSeries identified by $associatedTargetSeries
			- the series is complete
			- make note of the dose number after which the Series was marked complete as $doseNumberAfterWhichComplete
			- the effective number of doses administered in the Series is < $doseNumberAfterWhichComplete+2
		The patient information $oEvaluatedPersonAbstract must be known to complete writing this rule
			- make note of the date as $dateAt18yOfAge when the patient is "18y" of age
			- make note of the date as $dateAt50yOfAge when the patient is "50y" of age
			- the date $currentShotDate >= $dateAt18yOfAge
			- the date $currentShotDate < $dateAt50yOfAge
	then
		Set the Shot Status of $currentShot to Valid
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end


rule "COVID-19: If the shot administration date < 9/2/2022 and at >= 5 yrs and < 50 yrs of age for an Additional Dose and/or 1st Booster Dose in the __Pfizer, Mixed Product, Janssen or Series not authorized by the FDA but authorized by the WHO__, the shot is permitted"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	activation-group "extraDoseCheck"
	when
		There is an administered shot $currentShot that needs to be evaluated
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the shot belongs to the Series with name a member of ("COVID19PfizerSeries", "COVID19MixedProductSeries", "COVID19Janssen1DoseSeries", "COVID19AstraZeneca2DoseSeries", "COVID19BIBPSinopharm2DoseSeries", "COVID19CoronaVacSinovac2DoseSeries", "COVID19COVAXIN2DoseSeries", "COVID19Novavax2DoseSeries", "COVID19Medicago2DoseSeries")
			- the vaccine administered a member of ("ICE207", "ICE208", "ICE211", "ICE212", "ICE213", "ICE217", "ICE218", "ICE219", "ICE221", "ICE227", "ICE228", "ICE229", "ICE230", "ICE300", "ICE301", "ICE302", "ICE519", "ICE520")
			- make note of the date this shot was administered as $currentShotDate
			- the date $currentShotDate < "02-Sep-2022"
			- make note of the associated series as $associatedTargetSeries
		There is a Series $targetSeries identified by $associatedTargetSeries
			- the series is complete
			- make note of the dose number after which the Series was marked complete as $doseNumberAfterWhichComplete
			- the effective number of doses administered in the Series is < $doseNumberAfterWhichComplete+2
		The patient information $oEvaluatedPersonAbstract must be known to complete writing this rule
			- make note of the date as $dateAt5yOfAge when the patient is "5y" of age
			- make note of the date as $dateAt50yOfAge when the patient is "50y" of age
			- the date $currentShotDate >= $dateAt5yOfAge
			- the date $currentShotDate < $dateAt50yOfAge
	then
		Set the Shot Status of $currentShot to Valid
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $targetSeries
end


rule "COVID-19: If the shot administration date is < 9/2/2022 and at >= 50 yrs of age for an Additional Dose, 1st Booster Dose or 2nd Booster Dose in the __Pfizer, Moderna, Mixed Product, Janssen, Novavax or Series not authorized by the FDA but authorized by the WHO__, the shot is permitted"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	activation-group "extraDoseCheck"
	when
		There is an administered shot $currentShot that needs to be evaluated
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the shot belongs to the Series with name a member of ("COVID19PfizerSeries", "COVID19ModernaSeries", "COVID19MixedProductSeries", "COVID19Janssen1DoseSeries", "COVID19AstraZeneca2DoseSeries", "COVID19BIBPSinopharm2DoseSeries", "COVID19CoronaVacSinovac2DoseSeries", "COVID19COVAXIN2DoseSeries", "COVID19Novavax2DoseSeries", "COVID19Medicago2DoseSeries")
			- the vaccine administered a member of ("ICE207", "ICE208", "ICE211", "ICE212", "ICE213", "ICE217", "ICE218", "ICE219", "ICE221", "ICE227", "ICE228", "ICE229", "ICE230", "ICE300", "ICE301", "ICE302", "ICE519", "ICE520")
			- make note of the date this shot was administered as $currentShotDate
			- the date $currentShotDate < "02-Sep-2022"
			- make note of the associated series as $associatedTargetSeries
		There is a Series $targetSeries identified by $associatedTargetSeries
			- the series is complete
			- make note of the dose number after which the Series was marked complete as $doseNumberAfterWhichComplete
			- the effective number of doses administered in the Series is < $doseNumberAfterWhichComplete+3
		The patient information $oEvaluatedPersonAbstract must be known to complete writing this rule
			- make note of the date as $dateAt50yOfAge when the patient is "50y" of age
			- the date $currentShotDate >= $dateAt50yOfAge
	then
		Set the Shot Status of $currentShot to Valid
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $targetSeries
end

//////////////////////////////////////////////////////////////////////
// END Pfizer, Moderna, Novavax or Authorized WHO Series Additional/Booster Logic
//////////////////////////////////////////////////////////////////////

/*************************************************************************************************
 END < 9/2/2022
/************************************************************************************************/

/*************************************************************************************************
 START (Bivalent) Boosters >= 9/2/2022
/************************************************************************************************/

rule "COVID-19: If the shot administration date >= 9/2/2022 and < 9/12/2023 and at >= 5 yrs of age and an Additional (monovalent) Dose is administered in the __Pfizer, Moderna, Mixed Product, Janssen or Series not authorized by the FDA but authorized by the WHO__, the shot is permitted"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	activation-group "extraDoseCheck"
	when
		There is an administered shot $currentShot that needs to be evaluated
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the shot belongs to the Series with name a member of ("COVID19PfizerSeries", "COVID19ModernaSeries", "COVID19MixedProductSeries", "COVID19Janssen1DoseSeries", "COVID19AstraZeneca2DoseSeries", "COVID19BIBPSinopharm2DoseSeries", "COVID19CoronaVacSinovac2DoseSeries", "COVID19COVAXIN2DoseSeries", "COVID19Novavax2DoseSeries", "COVID19Medicago2DoseSeries")
			- the vaccine administered a member of ("ICE207", "ICE208", "ICE211", "ICE212", "ICE213", "ICE217", "ICE218", "ICE219", "ICE221", "ICE227", "ICE228")
			- make note of the date this shot was administered as $currentShotDate
			- the date $currentShotDate >= "02-Sep-2022"
			- the date $currentShotDate < "12-Sep-2023"
			- make note of the associated series as $associatedTargetSeries
		There is a Series $targetSeries identified by $associatedTargetSeries
			- the series is complete
			- make note of the dose number after which the Series was marked complete as $doseNumberAfterWhichComplete
			- the effective number of doses administered in the Series is < $doseNumberAfterWhichComplete+1
		The patient information $oEvaluatedPersonAbstract must be known to complete writing this rule
			- make note of the date as $dateAt5yOfAge when the patient is "5y" of age
			- the date $currentShotDate >= $dateAt5yOfAge
	then
		Set the Shot Status of $currentShot to Valid
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $targetSeries
end


rule "COVID-19(Abstract): Determination if additional dose and/or up to 3 booster dose(s) is permitted when administered < 4/19/2023 and >= 9/2/22 for >= 12 yrs of age, >= 10/12/2022 for >=5 yrs of age and < 12 yrs of age, or >= 12/8/2022 for >= 6 months of age in the Moderna Series"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	when
		There is an administered shot $currentShot that needs to be evaluated
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the series that the shot belongs to is complete
			- the administration date of the shot is >= "02-Sep-2022"
			- the administration date of the shot is < "19-Apr-2023"
			- the vaccine administered a member of ("ICE207", "ICE208", "ICE211", "ICE212", "ICE213", "ICE217", "ICE218", "ICE219", "ICE221", "ICE227", "ICE228", "ICE229", "ICE230", "ICE300", "ICE301", "ICE302", "ICE519", "ICE520")
			- make note of the date this shot was administered as $currentShotDate
			- make note of the dose number as $doseNumberCurrentShot
			- make note of the associated series as $associatedTargetSeries
		There is a Series $targetSeries identified by $associatedTargetSeries
			- make note of the dose number after which the Series was marked complete as $doseNumberAfterWhichComplete
			- the numeric $doseNumberAfterWhichComplete is >= $doseNumberCurrentShot-4
		The patient information $oEvaluatedPerson must be known to complete writing this rule
			- make note of the date as $dateAt6mOfAge when the patient is "6m" of age
			- make note of the date as $dateAt5yOfAge when the patient is "5y" of age
			- make note of the date as $dateAt12yOfAge when the patient is "12y" of age
	then
		Record that this dose rule was Processed for the TargetDose $currentShot
        Log that this dose rule fired for the dose $currentShot in the Series $targetSeries
end


rule "COVID-19: If the shot administration date is >= 9/2/2022 at >= 12 yr of age and have had an Additional Dose and/or 3 Booster Doses is administered in the __Pfizer, Moderna, Mixed Product, Janssen, Novavax or WHO-approved Series__, with not more than 1 booster after 9/2/2022, the shot is permitted"
		extends "COVID-19(Abstract): Determination if additional dose and/or up to 3 booster dose(s) is permitted when administered < 4/19/2023 and >= 9/2/22 for >= 12 yrs of age, >= 10/12/2022 for >=5 yrs of age and < 12 yrs of age, or >= 12/8/2022 for >= 6 months of age in the Moderna Series"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	activation-group "extraDoseCheck"
	when
		There is an administered shot $sameShotAsCurrentShot0902
			- that is the same shot as $currentShot
			- make note of the date this shot was administered as $sameShotAsCurrentShotDate0902
			- the date $sameShotAsCurrentShotDate0902 >= "02-Sep-2022"
			- the date $sameShotAsCurrentShotDate0902 >= $dateAt12yOfAge
		There does not exist another administered shot
			- the shot belongs to the series $targetSeries
			- that is not the same shot as $sameShotAsCurrentShot0902
			- that has already been evaluated and whose shot validity is VALID
			- the dose number in the Series is >= $doseNumberAfterWhichComplete+2
			- the administration date of the shot is >= "02-Sep-2022"
	then
		Set the Shot Status of $currentShot to Valid
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $targetSeries
end


rule "COVID-19: If the shot administration date is >= 10/12/2022 at >= 5 yr of age and have had an Additional Dose and/or 3 Booster Doses is administered in the __Pfizer, Moderna, Mixed Product, Janssen, Novavax or WHO-approved Series__, with not more than 1 booster after 9/2/2022, the shot is permitted"
		extends "COVID-19(Abstract): Determination if additional dose and/or up to 3 booster dose(s) is permitted when administered < 4/19/2023 and >= 9/2/22 for >= 12 yrs of age, >= 10/12/2022 for >=5 yrs of age and < 12 yrs of age, or >= 12/8/2022 for >= 6 months of age in the Moderna Series"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	activation-group "extraDoseCheck"
	when
		There is an administered shot $sameShotAsCurrentShot1012
			- that is the same shot as $currentShot
			- make note of the date this shot was administered as $sameShotAsCurrentShotDate1012
			- the date $sameShotAsCurrentShotDate1012 >= "12-Oct-2022"
			- the date $sameShotAsCurrentShotDate1012 >= $dateAt5yOfAge
		There does not exist another administered shot
			- the shot belongs to the series $targetSeries
			- that is not the same shot as $sameShotAsCurrentShot1012
			- that has already been evaluated and whose shot validity is VALID
			- the dose number in the Series is >= $doseNumberAfterWhichComplete+2
			- the administration date of the shot is >= "02-Sep-2022"
	then
		Set the Shot Status of $currentShot to Valid
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $targetSeries
end


rule "COVID-19: If the shot administration date is >= 12/8/2022 at >= 6 months of age and have had an Additional Dose and/or 3 Booster Doses is administered in the __Moderna Series__, with not more than 1 booster after 9/2/2022, the shot is permitted"
		extends "COVID-19(Abstract): Determination if additional dose and/or up to 3 booster dose(s) is permitted when administered < 4/19/2023 and >= 9/2/22 for >= 12 yrs of age, >= 10/12/2022 for >=5 yrs of age and < 12 yrs of age, or >= 12/8/2022 for >= 6 months of age in the Moderna Series"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	activation-group "extraDoseCheck"
	when
		There is an administered shot $sameShotAsCurrentShot1208
			- that is the same shot as $currentShot
			- the shot belongs to the Series with name "COVID19ModernaSeries"
			- make note of the date this shot was administered as $sameShotAsCurrentShotDate1208
			- the date $sameShotAsCurrentShotDate1208 >= "08-Dec-2022"
			- the date $sameShotAsCurrentShotDate1208 >= $dateAt6mOfAge
		There does not exist another administered shot
			- the shot belongs to the series $targetSeries
			- that is not the same shot as $sameShotAsCurrentShot1208
			- that has already been evaluated and whose shot validity is VALID
			- the dose number in the Series is >= $doseNumberAfterWhichComplete+2
			- the administration date of the shot is >= "02-Sep-2022"
	then
		Set the Shot Status of $currentShot to Valid
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $targetSeries
end

/*************************************************************************************************
 END >= 9/2/2022
/************************************************************************************************/

/*************************************************************************************************************************************************************************************
 END Rules for an Additional Dose and/or Booster Dose in all Series
/************************************************************************************************************************************************************************************/


/*************************************************************************************************************************************************************************************
 START Evaluate Minimum Intervals for < 9/2/2022, >= 9/2/2022, and < 4/19/2023. Either add Supplemental text for an Additional Dose and/or Booster Dose, or
 Evaluate the Shot as Invalid / BELOW_MINIMUM_INTERVAL.
/************************************************************************************************************************************************************************************/

//////////////////////////////////////////////////////////////////////
// START- Verify Minimum Interval for First Booster Dose
//////////////////////////////////////////////////////////////////////

rule "COVID-19: Supplemental Text- If an additional and/or 1st booster dose is administered < 4/19/2023 to an already completed __Janssen Series or Novavax Series__ < 8 weeks after prior dose, include supplemental text that follows guidelines regarding minimum ages/intervals"
	dialect "mvel"
	agenda-group "HistoryEvaluation^postEvaluationCheck"
	when
		There is a Series $targetSeries
			- the Series belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series a member of ("COVID19Janssen1DoseSeries", "COVID19Novavax2DoseSeries")
			- the series is complete
			- make note of the dose number after which the Series was marked complete as $numberOfDosesRequired
			- the effective number of doses administered in the Series is == $numberOfDosesRequired+1
		There is an administered shot $administeredShot
			- the shot belongs to the series $targetSeries
			- that has already been evaluated and whose Shot Validity Status is VALID
			- the dose number in the Series is == $numberOfDosesRequired+1
			- the administration date of the shot is < "19-Apr-2023"
			- make note of the date this shot was administered as $currentShotDate
			- make note of the associated series as $associatedTargetSeries
		There does not exist an administered shot
			- the shot belongs to the series $targetSeries
			- that has already been evaluated
			- the administration date of the shot is > $currentShotDate
		There is an administered shot $priorShot
			- the shot belongs to the series $targetSeries
			- the administration date of the shot is < $currentShotDate
			- make note of the date this shot was administered as $priorShotDate
		There does not exist an administered shot
			- the shot belongs to the series $targetSeries
			- the administration date of the shot is > $priorShotDate
			- the administration date of the shot is < $currentShotDate
		Confirm elapsed time between $priorShotDate and $currentShotDate < "8w"
	then
		Include Supplemental Text "The timing of the administration of this shot does not follow the guidelines regarding the minimum interval of 8 weeks required for the 1st Booster Dose." for Valid Shot $administeredShot
		Record that this dose rule was Processed for the TargetDose $administeredShot
        Log that this dose rule fired for the dose $administeredShot in the Series $targetSeries
end


rule "COVID-19: Supplemental Text- If the shot administration date is < 9/2/2022 and an additional dose and/or 1st booster dose is administered to an already completed __Pfizer, Mixed Product, Moderna or WHO  Series__ < 5 months, include supplemental text that follow guidelines regarding minimum ages/intervals"
	dialect "mvel"
	agenda-group "HistoryEvaluation^postEvaluationCheck"
	when
		There is a Series $targetSeries
			- the Series belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series a member of ("COVID19PfizerSeries", "COVID19ModernaSeries", "COVID19MixedProductSeries", "COVID19AstraZeneca2DoseSeries", "COVID19BIBPSinopharm2DoseSeries", "COVID19CoronaVacSinovac2DoseSeries", "COVID19COVAXIN2DoseSeries", "COVID19Medicago2DoseSeries")
			- the series is complete
			- make note of the dose number after which the Series was marked complete as $numberOfDosesRequired
			- the effective number of doses administered in the Series is == $numberOfDosesRequired+1
		There is an administered shot $administeredShot
			- the shot belongs to the series $targetSeries
			- that has already been evaluated and whose Shot Validity Status is VALID
			- the dose number in the Series is == $numberOfDosesRequired+1
			- the administration date of the shot is < "02-Sep-2022"
			- make note of the date this shot was administered as $currentShotDate
		There does not exist an administered shot
			- the shot belongs to the series $targetSeries
			- that has already been evaluated
			- the administration date of the shot is > $currentShotDate
		There is an administered shot $priorShot
			- the shot belongs to the series $targetSeries
			- the administration date of the shot is < $currentShotDate
			- make note of the date this shot was administered as $priorShotDate
		There does not exist an administered shot
			- the shot belongs to the series $targetSeries
			- the administration date of the shot is > $priorShotDate
			- the administration date of the shot is < $currentShotDate
		Confirm elapsed time between $priorShotDate and $currentShotDate < "5m"
	then
		Include Supplemental Text "The timing of the administration of this shot does not follow the guidelines regarding the minimum interval of 5 months required for the 1st Booster Dose." for Valid Shot $administeredShot
		Record that this dose rule was Processed for the TargetDose $administeredShot
        Log that this dose rule fired for the dose $administeredShot in the Series $targetSeries
end


rule "COVID-19: Supplemental Text- If the shot administration date is >= 9/2/2022 & < 4/19/2023 and that additional dose and/or 1st booster dose was administered to an already completed __Pfizer, Mixed Product, Moderna or WHO  Series__ < 8 weeks, include supplemental text that follow guidelines regarding minimum ages/intervals"
	dialect "mvel"
	agenda-group "HistoryEvaluation^postEvaluationCheck"
	when
		There is a Series $targetSeries
			- the Series belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series a member of ("COVID19PfizerSeries", "COVID19ModernaSeries", "COVID19MixedProductSeries", "COVID19AstraZeneca2DoseSeries", "COVID19BIBPSinopharm2DoseSeries", "COVID19CoronaVacSinovac2DoseSeries", "COVID19COVAXIN2DoseSeries", "COVID19Medicago2DoseSeries")
			- the series is complete
			- make note of the dose number after which the Series was marked complete as $numberOfDosesRequired
			- the effective number of doses administered in the Series is == $numberOfDosesRequired+1
		There is an administered shot $administeredShot
			- the shot belongs to the series $targetSeries
			- that has already been evaluated and whose Shot Validity Status is VALID
			- the dose number in the Series is == $numberOfDosesRequired+1
			- the administration date of the shot is >= "02-Sep-2022"
			- the administration date of the shot is < "19-Apr-2023"
			- make note of the date this shot was administered as $currentShotDate
		There does not exist an administered shot
			- the shot belongs to the series $targetSeries
			- that has already been evaluated
			- the administration date of the shot is > $currentShotDate
		There is an administered shot $priorShot
			- the shot belongs to the series $targetSeries
			- the administration date of the shot is < $currentShotDate
			- make note of the date this shot was administered as $priorShotDate
		There does not exist an administered shot
			- the shot belongs to the series $targetSeries
			- the administration date of the shot is > $priorShotDate
			- the administration date of the shot is < $currentShotDate
		Confirm elapsed time between $priorShotDate and $currentShotDate < "8w"
	then
		Include Supplemental Text "The timing of the administration of this shot does not follow the guidelines regarding the minimum interval of 8 weeks required for the 1st Booster Dose." for Valid Shot $administeredShot
		Record that this dose rule was Processed for the TargetDose $administeredShot
        Log that this dose rule fired for the dose $administeredShot in the Series $targetSeries
end

//////////////////////////////////////////////////////////////////////
// END- Verify Minimum Interval for First Booster Dose
//////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////
// START- Verify Minimum Interval for Second Booster Dose
//////////////////////////////////////////////////////////////////////

rule "COVID-19: Supplemental Text- If the shot administration date is < 9/2/2022 and that 2nd booster dose was administered to an already completed __Pfizer, Moderna, Mixed Product, Janssen or WHO  Series__ < 4 months, include supplemental text that follow guidelines regarding minimum ages/intervals"
	dialect "mvel"
	agenda-group "HistoryEvaluation^postEvaluationCheck"
	when
		There is a Series $targetSeries
			- the Series belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series a member of ("COVID19PfizerSeries", "COVID19ModernaSeries", "COVID19MixedProductSeries", "COVID19Janssen1DoseSeries", "COVID19AstraZeneca2DoseSeries", "COVID19BIBPSinopharm2DoseSeries", "COVID19CoronaVacSinovac2DoseSeries", "COVID19COVAXIN2DoseSeries", "COVID19Medicago2DoseSeries")
			- the series is complete
			- make note of the dose number after which the Series was marked complete as $numberOfDosesRequired
			- the effective number of doses administered in the Series is == $numberOfDosesRequired+2
		There is an administered shot $administeredShot
			- the shot belongs to the series $targetSeries
			- that has already been evaluated and whose Shot Validity Status is VALID
			- the dose number in the Series is == $numberOfDosesRequired+2
			- the administration date of the shot is < "02-Sep-2022"
			- make note of the date this shot was administered as $currentShotDate
		There does not exist an administered shot
			- the shot belongs to the series $targetSeries
			- that has already been evaluated
			- the administration date of the shot is > $currentShotDate
		There is an administered shot $priorShot
			- the shot belongs to the series $targetSeries
			- the administration date of the shot is < $currentShotDate
			- make note of the date this shot was administered as $priorShotDate
		There does not exist an administered shot
			- the shot belongs to the series $targetSeries
			- the administration date of the shot is > $priorShotDate
			- the administration date of the shot is < $currentShotDate
		Confirm elapsed time between $priorShotDate and $currentShotDate < "4m"
	then
		Include Supplemental Text "The timing of the administration of this shot does not follow the guidelines regarding the minimum interval of 4 months required for the 2nd Booster Dose." for Valid Shot $administeredShot
		Record that this dose rule was Processed for the TargetDose $administeredShot
        Log that this dose rule fired for the dose $administeredShot in the Series $targetSeries
end


rule "COVID-19: Supplemental Text- If the shot administration date is >= 9/2/2022 & < 4/19/2023 and that 2nd booster dose was administered to an already completed __Pfizer, Moderna, Mixed Product, Janssen or WHO  Series__ < 8 weeks, include supplemental text that follow guidelines regarding minimum ages/intervals"
	dialect "mvel"
	agenda-group "HistoryEvaluation^postEvaluationCheck"
	when
		There is a Series $targetSeries
			- the Series belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the name of the Series a member of ("COVID19PfizerSeries", "COVID19ModernaSeries", "COVID19MixedProductSeries", "COVID19Janssen1DoseSeries", "COVID19AstraZeneca2DoseSeries", "COVID19BIBPSinopharm2DoseSeries", "COVID19CoronaVacSinovac2DoseSeries", "COVID19COVAXIN2DoseSeries", "COVID19Medicago2DoseSeries")
			- the series is complete
			- make note of the dose number after which the Series was marked complete as $numberOfDosesRequired
			- the effective number of doses administered in the Series is == $numberOfDosesRequired+2
		There is an administered shot $administeredShot
			- the shot belongs to the series $targetSeries
			- that has already been evaluated and whose Shot Validity Status is VALID
			- the dose number in the Series is == $numberOfDosesRequired+2
			- the administration date of the shot is >= "02-Sep-2022"
			- the administration date of the shot is < "19-Apr-2023"
			- make note of the date this shot was administered as $currentShotDate
		There does not exist an administered shot
			- the shot belongs to the series $targetSeries
			- that has already been evaluated
			- the administration date of the shot is > $currentShotDate
		There is an administered shot $priorShot
			- the shot belongs to the series $targetSeries
			- the administration date of the shot is < $currentShotDate
			- make note of the date this shot was administered as $priorShotDate
		There does not exist an administered shot
			- the shot belongs to the series $targetSeries
			- the administration date of the shot is > $priorShotDate
			- the administration date of the shot is < $currentShotDate
		Confirm elapsed time between $priorShotDate and $currentShotDate < "8w"
	then
		Include Supplemental Text "The timing of the administration of this shot does not follow the guidelines regarding the minimum interval of 8 weeks required for the 2nd Booster Dose." for Valid Shot $administeredShot
		Record that this dose rule was Processed for the TargetDose $administeredShot
        Log that this dose rule fired for the dose $administeredShot in the Series $targetSeries
end

//////////////////////////////////////////////////////////////////////
// END- Verify Minimum Interval for Second Booster Dose
//////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////
// Verify Minimum Interval for Third Booster Dose
//////////////////////////////////////////////////////////////////////

rule "COVID-19: If the 3rd booster dose is administered >= 9/2/2022 & < 4/19/2023 to an already completed __Pfizer, Moderna, Mixed Product, Janssen or WHO  Series__ < 8 weeks - 4 days, evaluate the shot as Invalid / BELOW_MINIMUM_INTERVAL"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	when
		There is an Administered Shot $currentShot that needs to be evaluated
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the series that the shot belongs to is complete
			- the shot belongs to the Series with name a member of ("COVID19PfizerSeries", "COVID19ModernaSeries", "COVID19MixedProductSeries", "COVID19Janssen1DoseSeries", "COVID19AstraZeneca2DoseSeries", "COVID19BIBPSinopharm2DoseSeries", "COVID19CoronaVacSinovac2DoseSeries", "COVID19COVAXIN2DoseSeries", "COVID19Medicago2DoseSeries")
			- the administration date of the shot is >= "02-Sep-2022"
			- the administration date of the shot is < "19-Apr-2023"
			- make note of the date this shot was administered as $currentShotDate
			- make note of the dose number as $doseNumberCurrentShot
			- make note of the Associated Series as $associatedTargetSeries
		There is a Series $targetSeries identified by $associatedTargetSeries
			- make note of the dose number after which the Series was marked complete as $numberOfDosesRequired
			- the numeric $doseNumberCurrentShot is >= $numberOfDosesRequired+3
			- the numeric $doseNumberCurrentShot is <= $numberOfDosesRequired+4
		There is an administered shot $priorShot
			- the shot belongs to the series $targetSeries
			- the administration date of the shot is < $currentShotDate
			- make note of the date this shot was administered as $priorShotDate
		There does not exist an administered shot
			- the shot belongs to the series $targetSeries
			- the administration date of the shot is > $priorShotDate
			- the administration date of the shot is < $currentShotDate
		Confirm elapsed time between $priorShotDate and $currentShotDate < "8w-4d"
	then
		Include the reason for shot $currentShot Invalid due to "Below Minimum Interval"
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end

/*************************************************************************************************************************************************************************************
 END Evaluate Minimum Intervals for < 9/2/2022, >= 9/2/2022, and < 4/19/2023. Either add Supplemental text for an Additional Dose and/or Booster Dose
 or Mark Shot Invalid / BELOW_MINIMUM_INTERVAL.
/************************************************************************************************************************************************************************************/


/*************************************************************************************************************************************************************************************
 START Single Bivalent Dose Logic for > 4/19/2023 and < 9/12/2023. Only 1 Bivalent vaccine dose required for series to be complete.
 Patients >= 65 yrs of age may optionally receive a 2nd dose of a bivalent vaccine.

 After completion of either the Pfizer COVID-19 Series, Mixed Product COVID-19 Series, and a shot is administered >= 3/17/2023 and < 9/12/2023; or (2) Moderna COVID-19 Series, Janssen COVID-19 Series, Novavax COVID-19 Series, or COVID-19 vaccine series not authorized by the FDA, but authorized by the WHO,
 or a COVID-19 vaccine series not authorized by the FDA or WHO, but is an active COVID-19 vaccine candidate as part of a U.S.-based clinical trial of a COVID-19 vaccine, and a shot is administered >= 4/19/2023
     If the patient has not received any bivalent doses via a combination of prior booster doses at >= 9/2/2022 and <9/12/2023, prior bivalent doses (CVX 229, CVX 230, CVX 300, CVX 301, CVX 302, CVX 519, or CVX 520) in the primary series, or prior doses administered >= 4/19/2023 in the primary series:
         at < 8 weeks after series completion, then evaluate the shot as Valid/ SUPPLEMENTAL_TEXT; Descriptive Text: "The timing of the administration of this shot does not follow the guidelines regarding the minimum interval of 8 weeks required for the 1st Booster Dose."
         at >= 8 weeks after series completion, then evaluate the shot as Valid
     Otherwise:
 	       If the patient is < 65 years of age:
             If 1 or more previous doses that are bivalent vaccines (CVX 229, CVX 230, CVX 300, CVX 301, CVX 302, CVX 519, or CVX 520) were administered as either a booster dose at >= 9/2/2022 or as a dose in the primary series, or, alternatively, a prior dose was administered >= 4/19/2023,
             evaluate the shot as Accepted / EXTRA_DOSE. (See Extra Shots section.)
         If the patient is >= 65 years of age:
             If 2 or more previous doses that are bivalent vaccines (CVX 229, CVX 230, CVX 300, CVX 301, CVX 302, CVX 519, or CVX 520) were administered as either a booster dose at >= 9/2/2023 or as a dose in the primary series, or, alternatively, a prior dose was administered >= 4/19/2023,
             evaluate the shot as Accepted / EXTRA_DOSE. (See Extra Shots section.)
             If 1 previous bivalent dose that is a bivalent vaccine (CVX 229, CVX 230, CVX 300, CVX 301, CVX 302, CVX 519, or CVX 520) was administered as either a booster dose at >= 9/2/2023 or as a dose in the primary series, or, alternatively, a prior dose was administered >= 4/19/2023:
                 at < 4 months after series completion, then evaluate the shot as Valid/ SUPPLEMENTAL_TEXT; Descriptive Text: "The timing of the administration of this shot does not follow the guidelines regarding the minimum interval of 4 months."
                 at >= 4 months after series completion, then evaluate the shot as Valid.
/************************************************************************************************************************************************************************************/

rule "COVID-19(Administration of Bivalent Dose in the Pfizer Series After Series Completion): If a shot is administered in the Pfizer series on >= 3/17/2023 and < 9/12/2023, the series is complete, and the patient has not received a dose of any bivalent vaccines < 3/17/2023, evaluate the shot as Valid"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	activation-group "extraDoseCheck"
	when
		There is an Administered Shot $currentShot that needs to be evaluated
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850" and the Series with name "COVID19PfizerSeries"
			- the administration date of the shot is >= "17-Mar-2023"
			- the administration date of the shot is < "12-Sep-2023"
			- make note of the date this shot was administered as $currentShotDate
			- make note of the Associated Series as $associatedTargetSeries
		There is an administered shot $priorShot
			- the shot belongs to the series $associatedTargetSeries
			- the administration date of the shot is < $currentShotDate
			- make note of the date this shot was administered as $priorShotDate
		There does not exist an administered shot
			- the shot belongs to the series $associatedTargetSeries
			- the administration date of the shot is > $priorShotDate
			- the administration date of the shot is < $currentShotDate
	then
		Set the Shot Status of $currentShot to Valid
		Record that this dose rule was Processed for the TargetDose $currentShot
        Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end


rule "COVID-19: If the first bivalent dose on >= 3/17/2023 and < 9/12/2023 after series completion was administered < 3 weeks from the prior COVID-19 shot, include supplemental text regarding a 3 week minimum interval"
		extends "COVID-19(Administration of Bivalent Dose in the Pfizer Series After Series Completion): If a shot is administered in the Pfizer series on >= 3/17/2023 and < 9/12/2023, the series is complete, and the patient has not received a dose of any bivalent vaccines < 3/17/2023, evaluate the shot as Valid"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	when
		There is an administered shot $sameShotAsCurrentShot
			- that is the same shot as $currentShot
			- make note of the dose number as $doseNumberCurrentShot
			- the numeric $doseNumberCurrentShot is == 2
		Confirm elapsed time between $priorShotDate and $currentShotDate < "3w"
	then
		Include the reason for shot $currentShot Invalid due to "Below Minimum Interval"
		Record that this dose rule was Processed for the TargetDose $currentShot
        Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end


rule "COVID-19: If the second bivalent dose on >= 3/17/2023 and < 9/12/2023 after series completion was administered < 4 weeks from the prior COVID-19 shot, include supplemental text regarding a 4 week minimum interval"
		extends "COVID-19(Administration of Bivalent Dose in the Pfizer Series After Series Completion): If a shot is administered in the Pfizer series on >= 3/17/2023 and < 9/12/2023, the series is complete, and the patient has not received a dose of any bivalent vaccines < 3/17/2023, evaluate the shot as Valid"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	when
		There is an administered shot $sameShotAsCurrentShot
			- that is the same shot as $currentShot
			- make note of the dose number as $doseNumberCurrentShot
			- the numeric $doseNumberCurrentShot is == 3
		Confirm elapsed time between $priorShotDate and $currentShotDate < "4w"
	then
		Include the reason for shot $currentShot Invalid due to "Below Minimum Interval"
		Record that this dose rule was Processed for the TargetDose $currentShot
        Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end

rule "COVID-19: If the third or greater bivalent dose on >= 3/17/2023 and < 9/12/2023 after series completion was administered < 8 weeks from the prior COVID-19 shot, include supplemental text regarding an 8 week minimum interval"
		extends "COVID-19(Administration of Bivalent Dose in the Pfizer Series After Series Completion): If a shot is administered in the Pfizer series on >= 3/17/2023 and < 9/12/2023, the series is complete, and the patient has not received a dose of any bivalent vaccines < 3/17/2023, evaluate the shot as Valid"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	when
		There is an administered shot $sameShotAsCurrentShot
			- that is the same shot as $currentShot
			- make note of the dose number as $doseNumberCurrentShot
			- the numeric $doseNumberCurrentShot is >= 4
		Confirm elapsed time between $priorShotDate and $currentShotDate < "8w"
	then
		Include the reason for shot $currentShot Invalid due to "Below Minimum Interval"
		Record that this dose rule was Processed for the TargetDose $currentShot
        Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end



rule "COVID-19(Administration of 1st Bivalent Dose in a non-Pfizer Series After Series Completion): If a shot is administered on >= 4/19/2023 and < 9/12/2023, the series is complete, and the patient has not received a dose of any bivalent vaccines < 4/19/2023 nor any COVID-19 dose >= 4/19/2023, evaluate the shot as Valid"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	activation-group "extraDoseCheck"
	when
		There is an Administered Shot $currentShot that needs to be evaluated
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the shot belongs to the Series with name a member of ("COVID19ModernaSeries", "COVID19MixedProductSeries", "COVID19Janssen1DoseSeries", "COVID19Novavax2DoseSeries")
			- the administration date of the shot is >= "19-Apr-2023"
			- the administration date of the shot is < "12-Sep-2023"
			- make note of the date this shot was administered as $currentShotDate
			- make note of the Associated Series as $associatedTargetSeries
		There is an administered shot $priorShot
			- the shot belongs to the series $associatedTargetSeries
			- the administration date of the shot is < $currentShotDate
			- make note of the date this shot was administered as $priorShotDate
		There does not exist an administered shot
			- the shot belongs to the series $associatedTargetSeries
			- the administration date of the shot is > $priorShotDate
			- the administration date of the shot is < $currentShotDate
	then
		Set the Shot Status of $currentShot to Valid
		Record that this dose rule was Processed for the TargetDose $currentShot
        Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end


rule "COVID-19: If the first or second bivalent dose on >= 4/19/2023 and < 9/12/2023 after series completion was administered < 4 weeks from the prior COVID-19 shot, include supplemental text regarding an 4 week minimum interval"
		extends "COVID-19(Administration of 1st Bivalent Dose in a non-Pfizer Series After Series Completion): If a shot is administered on >= 4/19/2023 and < 9/12/2023, the series is complete, and the patient has not received a dose of any bivalent vaccines < 4/19/2023 nor any COVID-19 dose >= 4/19/2023, evaluate the shot as Valid"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	when
		There is an administered shot $sameShotAsCurrentShot
			- that is the same shot as $currentShot
			- make note of the dose number as $doseNumberCurrentShot
			- the numeric $doseNumberCurrentShot is <= 3
		Confirm elapsed time between $priorShotDate and $currentShotDate < "4w"
	then
		Include the reason for shot $currentShot Invalid due to "Below Minimum Interval"
		Record that this dose rule was Processed for the TargetDose $currentShot
        Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end


rule "COVID-19: If the first or second bivalent dose on >= 4/19/2023 and < 9/12/2023 after series completion was administered >= 4 weeks from the prior COVID-19 shot, include supplemental text regarding an 8 week minimum interval"
		extends "COVID-19(Administration of 1st Bivalent Dose in a non-Pfizer Series After Series Completion): If a shot is administered on >= 4/19/2023 and < 9/12/2023, the series is complete, and the patient has not received a dose of any bivalent vaccines < 4/19/2023 nor any COVID-19 dose >= 4/19/2023, evaluate the shot as Valid"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	when
		There is an administered shot $sameShotAsCurrentShot
			- that is the same shot as $currentShot
			- make note of the dose number as $doseNumberCurrentShot
			- the numeric $doseNumberCurrentShot is >= 4
		Confirm elapsed time between $priorShotDate and $currentShotDate < "8w"
	then
		Include the reason for shot $currentShot Invalid due to "Below Minimum Interval"
		Record that this dose rule was Processed for the TargetDose $currentShot
        Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end

// If a shot is administered to a patient >= 65 yrs of age, and 1 bivalent vaccine dose (CVX 229, CVX 230, CVX 300, CVX 301, CVX 302, CVX 519, or CVX 520) was previously administered as a booster dose at >= 9/2/2023 and < 9/12/2023 or as a dose in the primary series,
// or, alternatively, any prior dose was administered on >= 4/19/2023 and < 9/12/2023, evaluate the shot as Accepted / EXTRA_DOSE"
rule "COVID-19: If a shot was administered to a patient >= 65 yrs of age, and if 1 bivalent dose was previously administered or, alternatively, 1 was prior dose was administered on >= 4/19/2023, evaluate the shot as Valid"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	activation-group "extraDoseCheck"
	salience 10
	when
		There is an Administered Shot $currentShot that needs to be evaluated
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the series that the shot belongs to is complete
			- the administration date of the shot is >= "19-Apr-2023"
			- the administration date of the shot is < "12-Sep-2023"
			- make note of the date this shot was administered as $currentShotDate
			- make note of the dose number as $doseNumberCurrentShot
			- make note of the Associated Series as $associatedTargetSeries
		Make note of the number of doses administered $doseAccumulationBivalent in Series $associatedTargetSeries as $nNumberOfBivalentDoses where administration date < "19-Apr-2023" with vaccine a member of ("ICE229", "ICE230", "ICE300", "ICE301", "ICE302", "ICE519", "ICE520")
		Make note of the number of doses administered $doseAccumulationApr19 in Series $associatedTargetSeries as $nDosesAdministeredAfter041923 where administration date >= "19-Apr-2023" with vaccine a member of ("ICE207", "ICE208", "ICE213", "ICE217", "ICE218", "ICE219", "ICE221", "ICE227", "ICE228", "ICE229", "ICE230", "ICE300", "ICE301", "ICE302", "ICE519", "ICE520")
		The patient information $oEvaluatedPerson must be known to complete writing this rule
			- make note of the patient's birthdate as $birthdate
		Confirm elapsed time between $birthdate and $currentShotDate >= "65y"
		// Confirm the variable $nNumberOfBivalentDoses is == 1 && the variable $nDosesAdministeredAfter041923  is == 0 || the variable $nNumberOfBivalentDoses is == 0 && the variable $nDosesAdministeredAfter041923  is == 1
		Confirm that the following is true: ($nNumberOfBivalentDoses + $nDosesAdministeredAfter041923 == 1)
	then
		Set the Shot Status of $currentShot to Valid
		Record that this dose rule was Processed for the TargetDose $currentShot
        Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end


// If the patient is >= 65 yrs of age and 2 or more previous doses that are bivalent vaccines (CVX 229, CVX 230, CVX 300, CVX 301, CVX 302, CVX 519, or CVX 520) were administered as either a booster dose at >= 9/2/2023 or as a dose in the primary series,
// or, alternatively, a prior dose was administered >= 4/19/2023 and < 9/12/2023, evaluate the shot as Accepted / EXTRA_DOSE"
// ... No rule needs to be written for this circumstance ... ICE evaluates extra doses as Accepted / EXTRA_DOSE by default.


rule "COVID-19: If a 2nd bivalent dose was administered to a patient >= 65 yrs of age at < 4 months from the previous shot, include supplemental text regarding a 4 month minimum intervals"
	dialect "mvel"
	agenda-group "HistoryEvaluation^postEvaluationCheck"
	when
		There is an administered shot $latestShot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- that has already been Evaluated and whose Shot Validity is VALID
			- the series that the shot belongs to is complete
			- the administration date of the shot is >= "19-Apr-2023"
			- the administration date of the shot is < "12-Sep-2023"
			- make note of the date this shot was administered as $latestShotDate
			- make note of the dose number as $doseNumberLatestShot
			- make note of the Associated Series as $associatedTargetSeries
		There is an administered shot $priorShot
			- the shot belongs to the series $associatedTargetSeries
			- the administration date of the shot is < $latestShotDate
			- make note of the date this shot was administered as $priorShotDate
		There does not exist an administered shot
			- the shot belongs to the series $associatedTargetSeries
			- that has already been evaluated
			- the administration date of the shot is > $priorShotDate
			- the administration date of the shot is < $latestShotDate
		Make note of the number of doses administered $doseAccumulationBivalent in Series $associatedTargetSeries as $nNumberOfBivalentDoses where administration date < "19-Apr-2023" with vaccine a member of ("ICE229", "ICE230", "ICE300", "ICE301", "ICE302", "ICE519", "ICE520")
		Make note of the number of doses administered $doseAccumulationApr19 in Series $associatedTargetSeries as $nDosesAdministeredAfter041923 where administration date >= "19-Apr-2023" with vaccine a member of ("ICE207", "ICE208", "ICE213", "ICE217", "ICE218", "ICE219", "ICE221", "ICE227", "ICE228", "ICE229", "ICE230", "ICE300", "ICE301", "ICE302", "ICE519", "ICE520")
		The patient information $oEvaluatedPerson must be known to complete writing this rule
			- make note of the patient's birthdate as $birthdate
		Confirm elapsed time between $birthdate and $latestShotDate >= "65y"
		Confirm elapsed time between $priorShotDate and $latestShotDate < "4m"
		Confirm that the following is true: $nDosesAdministeredAfter041923 >= 1 && $nDosesAdministeredAfter041923 <= 2 && ($nNumberOfBivalentDoses + $nDosesAdministeredAfter041923 >= 2)
	then
		Include the reason for shot $latestShot Invalid due to "Below Minimum Interval"
		Record that this dose rule was Processed for the TargetDose $latestShot
        Log that this dose rule fired for the dose $latestShot in the Series $associatedTargetSeries
end

/*************************************************************************************************************************************************************************************
 END Single Bivalent Dose Logic for > 4/19/2023 and < 9/12/2023. Only 1 Bivalent vaccine dose required for series to be complete.
 Patients >= 65 yrs of age may optionally receive a 2nd dose of a bivalent vaccine.
/************************************************************************************************************************************************************************************/


/*************************************************************************************************************************************************************************************
 START Series Special Evaluation Rules when Series is Not Complete
/************************************************************************************************************************************************************************************/

rule "COVID-19: If CVX 302 or CVX 308 is admininstered for target dose 3 in the Pfizer series, there is no absolute maximum age for the vaccine"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	activation-group "maximumAgeVaccineCheck"
	when
		There is an administered shot $administeredShot that needs to be evaluated
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850" and the Series with name "COVID19PfizerSeries"
			- the series that the shot belongs to is not complete
			- the dose number in the Series is == 3
			- make note of the Associated Series as $associatedTargetSeries
	then
		// Override maximum age vaccine check
		Record that this dose rule was Processed for the TargetDose $administeredShot
		Log that this dose rule fired for the dose $administeredShot in the Series $associatedTargetSeries
end


//////////////////////////////////////////////////////////////////////////////////////////////////
// CVX 218, CVX 219, CVX 227, CVX 228, CVX 301, CVX 302, CVX 308, CVX 310, 311 - if evaluated as Invalid due to being above the maximum age for that vaccine, should be ignored for purposes of recommendations
// because the dose should be readministered immediately with no minimum interval
//////////////////////////////////////////////////////////////////////////////////////////////////

rule "COVID-19: If CVX 218, CVX 219, CVX 227, CVX 228, CVX 229, CVX 230, CVX 301 or CVX 302 was evaluated and Not Valid due to ABOVE_MAXIMUM_AGE_VACCINE, ignore the shot when calculating intervals"
	dialect "mvel"
	agenda-group "HistoryEvaluation^postEvaluationCheck"
	when
		There is an administered shot $administeredShot
			- the shot belongs to the vaccine group "VACCINE_GROUP_CONCEPT.850"
			- the vaccine administered a member of  ("ICE218", "ICE219", "ICE227", "ICE228", "ICE229", "ICE230", "ICE301", "ICE302", "ICE308", "ICE310", "ICE311")
			- that has already been evaluated and whose Shot Validity Status is not VALID
			- the shot is not ignored
			- make note of all evaluation reasons for this shot as $collectionOfStrReasons
			- the collection $collectionOfStrReasons contains "EVALUATION_REASON_CONCEPT.ABOVE_MAXIMUM_AGE_VACCINE"
			- make note of the Associated Series as $associatedTargetSeries
	then
		Mark the shot $administeredShot as Ignored
		Refresh all facts in the shot $administeredShot
		Record that this dose rule was Processed for the TargetDose $administeredShot
		Log that this dose rule fired for the dose $administeredShot in the Series $associatedTargetSeries
end

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START - "Skip dose" logic when Series is Not Complete
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// END - "Skip dose" logic when Series is Not Complete
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// If a Moderna bivalent vaccine (CVX 229, CVX 230) is inadvertently administered in the Pfizer or Mixed Product primary series and was evaluated as INVALID with reason code
// VACCINE_NOT_ALLOWED_FOR_THIS_DOSE, ignore the bivalent vaccine (CVX 229, CVX 230) when determining the recommended due date for the next target dose due and when
// evaluating the next shot based on the absolute minimum interval for that target dose.
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

rule "COVID-19: If CVX 229 or CVX 230 was evaluated as Not Valid due to VACCINE_NOT_ALLOWED_FOR_THIS_DOSE in the Pfizer, Moderna or Mixed Product Series, Ignore the shot when calculating intervals"
	dialect "mvel"
	agenda-group "HistoryEvaluation^postEvaluationCheck"
	when
		There is an administered shot $administeredShot
			- the vaccine administered a member of ("ICE229", "ICE230")
			- the shot belongs to the vaccine group "VACCINE_GROUP_CONCEPT.850"
			- the shot belongs to the Series with name a member of ("COVID19PfizerSeries", "COVID19ModernaSeries", "COVID19MixedProductSeries")
			- that has already been evaluated and whose Shot Validity Status is not VALID
			- the shot is not ignored
			- make note of all evaluation reasons for this shot as $collectionOfStrReasons
			- the collection $collectionOfStrReasons contains "EVALUATION_REASON_CONCEPT.VACCINE_NOT_ALLOWED_FOR_THIS_DOSE"
			- make note of the Associated Series as $associatedTargetSeries
	then
		Mark the shot $administeredShot as Ignored
		Refresh all facts in the shot $administeredShot
		Record that this dose rule was Processed for the TargetDose $administeredShot
		Log that this dose rule fired for the dose $administeredShot in the Series $associatedTargetSeries
end


/*************************************************************************************************************************************************************************************
 END Series Special Evaluation Rules when Series is Not Complete
/************************************************************************************************************************************************************************************/


/*************************************************************************************************************************************************************************************
 START If the patient receives a shot below the absolute minimum age, or below the absolute minimum interval prior to 10/25/2021, override vaccine minimum age and series intervals
 and evaluate the shot as Valid
/************************************************************************************************************************************************************************************/

rule "COVID-19: If CVX 212 is administered below the age of 18y-4d in the Janssen Series, override absolute vaccine minimum age check _and_ return supplemental text that the shot does not follow guidelines for minimum age"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	activation-group "minimumAgeVaccineCheck"
	salience 5
	when
		There is an Administered Shot $currentShot that needs to be evaluated
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850" and the Series with name "COVID19Janssen1DoseSeries"
			- the Vaccine Administered is "ICE212"
			- make note of the date this shot was administered as $administrationDate
			- make note of the associated series as $associatedTargetSeries
		The patient information $oEvaluatedPerson must be known to complete writing this rule
			- make note of the patient's birthdate as $dtBirthDate
		Confirm Elapsed time between $dtBirthDate and $administrationDate < "18y-4d"
	then
		Include Supplemental Text "The timing of the administration of this shot does not follow the guidelines regarding the minimum age." for Valid Shot $currentShot
		Record that this dose rule was Processed for the TargetDose $currentShot
        Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end

rule "COVID-19: For patients >= 18 yrs of age, if shot in the Pfizer, Mixed Product or Moderna series is administered prior to 10/25/2021 and the series is not complete, override series interval logic"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	activation-group "doseIntervalCheck"
	when
		There is an Administered Shot $currentShot that needs to be evaluated
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the administered shot number is > 1
			- make note of the administered shot number as $administeredShotNumber
			- make note of the date this shot was administered as $administrationDate
			- the date $administrationDate < "25-Oct-2021"
			- make note of the associated series as $associatedTargetSeries
		There is a Series $targetSeries identified by $associatedTargetSeries
			- the name of the Series a member of ("COVID19PfizerSeries", "COVID19MixedProductSeries", "COVID19ModernaSeries")
		The patient information $oEvaluatedPerson must be known to complete writing this rule
			- make note of the date as $dtDateAtAge18y when the patient is "18y" of age
		There is an Administered Shot $priorDose
			- the shot belongs to the series $associatedTargetSeries
			- that has already been evaluated
			- the administered shot number is == $administeredShotNumber-1
			- the administration date of the shot is >= $dtDateAtAge18y
			- make note of the date this shot was administered as $administrationDatePrior
		There does not exist an Administered Shot
			- the shot belongs to the series $associatedTargetSeries
			- that has already been evaluated
			- the administered shot number is == $administeredShotNumber-1
			- the administration date of the shot is > $administrationDatePrior
		/////// Confirm the date $administrationDate is before "25-Oct-2021"
	then
		Record that this dose rule was Processed for the TargetDose $currentShot
        Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end




//////////////////////////////////////////////////////////////////////////////////////////////////
// Moderna: absolute minimum interval from a prior Moderna shot to the current shot is 24 days
//////////////////////////////////////////////////////////////////////////////////////////////////

rule "COVID-19: For patients >= 18y, enforce absolute minimum interval of 24 days *from* any prior Moderna or CVX 213 shots (in any Series) if after 10/25/2021"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	when
		There is an Administered Shot $currentShot that needs to be evaluated
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the series that the shot belongs to is not complete
			- make note of the date this shot was administered as $dtAdministrationDateCurrentShot
			- make note of the dose number as $doseNumberCurrentShot
			- make note of the Associated Series as $associatedTargetSeries
		There is an administered shot $priorModernaShot
			- the shot belongs to the Series $associatedTargetSeries
			- that has already been evaluated
			- the dose number in the series is < $doseNumberCurrentShot
			- the vaccine administered a member of ("ICE207", "ICE213", "ICE221", "ICE227", "ICE228", "ICE229", "ICE230", "ICE519", "ICE311", "ICE312")
		The patient information $oEvaluatedPerson must be known to complete writing this rule
			- make note of the date as $dtDateAtAge18y when the patient is "18y" of age
		There is an Administered Shot $priorShot
			- that is the same shot as $priorModernaShot
			- the administration date of the shot is >= $dtDateAtAge18y
			- make note of the date this shot was administered as $dtAdministrationDatePriorCVXdose
		Confirm the date $dtAdministrationDateCurrentShot is on the same date or after "25-Oct-2021"
		Confirm Elapsed time between $dtAdministrationDatePriorCVXdose and $dtAdministrationDateCurrentShot < "24d"
	then
		Include the reason for shot $currentShot Invalid due to "Below Minimum Interval"
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end


rule "COVID-19: For patients >= 18y, enforce absolute minimum interval of 24 days *to* any Moderna or CVX 213 shots (in any Series) if after 10/25/2021"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	when
		There is an Administered Shot $currentShot that needs to be evaluated
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the series that the shot belongs to is not complete
			- the vaccine administered a member of ("ICE207", "ICE213", "ICE221", "ICE227", "ICE228", "ICE229", "ICE230", "ICE519", "ICE520", "ICE311", "ICE312")
			- make note of the date this shot was administered as $dtAdministrationDateCurrentShot
			- make note of the dose number as $doseNumberCurrentShot
			- make note of the Associated Series as $associatedTargetSeries
		There is an administered shot $priorOtherShot
			- the shot belongs to the Series $associatedTargetSeries
			- that has already been evaluated
			- the dose number in the series is < $doseNumberCurrentShot
		The patient information $oEvaluatedPerson must be known to complete writing this rule
			- make note of the date as $dtDateAtAge18y when the patient is "18y" of age
		There is an Administered Shot $priorShot
			- that is the same shot as $priorOtherShot
			- the administration date of the shot is >= $dtDateAtAge18y
			- make note of the date this shot was administered as $dtAdministrationDatePriorCVXdose
		Confirm the date $dtAdministrationDateCurrentShot is on the same date or after "25-Oct-2021"
		Confirm Elapsed time between $dtAdministrationDatePriorCVXdose and $dtAdministrationDateCurrentShot < "24d"
	then
		Include the reason for shot $currentShot Invalid due to "Below Minimum Interval"
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end


rule "COVID-19: For patients < 18y, always enforce absolute minimum interval of 24 days *from* any prior Moderna or CVX 213 shots (in any Series)"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	when
		There is an Administered Shot $currentShot that needs to be evaluated
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the series that the shot belongs to is not complete
			- make note of the date this shot was administered as $dtAdministrationDateCurrentShot
			- make note of the dose number as $doseNumberCurrentShot
			- make note of the Associated Series as $associatedTargetSeries
		There is an administered shot $priorModernaShot
			- the shot belongs to the Series $associatedTargetSeries
			- that has already been evaluated
			- the dose number in the series is < $doseNumberCurrentShot
			- the vaccine administered a member of ("ICE207", "ICE213", "ICE221", "ICE227", "ICE228", "ICE229", "ICE230", "ICE519", "ICE520", "ICE311", "ICE312")
		The patient information $oEvaluatedPerson must be known to complete writing this rule
			- make note of the date as $dtDateAtAge18y when the patient is "18y" of age
		There is an Administered Shot $priorShot
			- that is the same shot as $priorModernaShot
			- the administration date of the shot is < $dtDateAtAge18y
			- make note of the date this shot was administered as $dtAdministrationDatePriorCVXdose
		Confirm Elapsed time between $dtAdministrationDatePriorCVXdose and $dtAdministrationDateCurrentShot < "24d"
	then
		Include the reason for shot $currentShot Invalid due to "Below Minimum Interval"
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end


rule "COVID-19: For patients < 18y, always enforce absolute minimum interval of 24 days *to* any prior Moderna or CVX 213 shots (in any Series)"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	when
		There is an Administered Shot $currentShot that needs to be evaluated
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the series that the shot belongs to is not complete
			- the vaccine administered a member of ("ICE207", "ICE213", "ICE221", "ICE227", "ICE228", "ICE229", "ICE230", "ICE519", "ICE520", "ICE311", "ICE312")
			- make note of the date this shot was administered as $dtAdministrationDateCurrentShot
			- make note of the dose number as $doseNumberCurrentShot
			- make note of the Associated Series as $associatedTargetSeries
		There is an administered shot $priorOtherShot
			- the shot belongs to the Series $associatedTargetSeries
			- that has already been evaluated
			- the dose number in the series is < $doseNumberCurrentShot
		The patient information $oEvaluatedPerson must be known to complete writing this rule
			- make note of the date as $dtDateAtAge18y when the patient is "18y" of age
		There is an Administered Shot $priorShot
			- that is the same shot as $priorOtherShot
			- the administration date of the shot is < $dtDateAtAge18y
			- make note of the date this shot was administered as $dtAdministrationDatePriorCVXdose
		Confirm Elapsed time between $dtAdministrationDatePriorCVXdose and $dtAdministrationDateCurrentShot < "24d"
	then
		Include the reason for shot $currentShot Invalid due to "Below Minimum Interval"
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end

/*************************************************************************************************************************************************************************************
 END If the patient receives a shot below the absolute minimum age, or below the absolute minimum interval prior to 10/25/2021, override vaccine minimum age and series intervals
 and evaluate the shot as Valid
/************************************************************************************************************************************************************************************/

//////////////////////////////////////////////////////////////////////////////////////////////////
// START Fall 2023-2024 Season
//////////////////////////////////////////////////////////////////////////////////////////////////


//////////////////////////////////////////////////////////////////////////////////////////////////
// START INVALID vaccines for Fall 2023-2024 Season
// Vaccines given on or after 9/12/2023 that are not in the Fall 2023-24 vaccine list always get evaluated as INVALID/VACCINE_NO_LONGER_RECOMMENDED_ON_DATE_SPECIFIED.
//////////////////////////////////////////////////////////////////////////////////////////////////

rule "COVID-19: If a vaccine that is not a Fall 2023-24 vaccine is given on or after 9/12/2023, and the series is not complete, evaluate it as INVALID/VACCINE_NO_LONGER_RECOMMENDED_ON_DATE_SPECIFIED"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	activation-group "allowableVaccineCheck"
	when
		There is an administered shot $currentShot that needs to be evaluated
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the vaccine administered not a member of ("ICE308", "ICE309", "ICE310", "ICE311", "ICE312", "ICE313", "ICE211")
			- the administration date of the shot is >= "12-Sep-2023"
			- the series that the shot belongs to is not complete
			- make note of the associated series as $targetSeries
	then
		Include the reason for shot $currentShot Invalid due to "Vaccine no longer recommended on date specified."
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $targetSeries
end

rule "COVID-19: If a Novavax 211 vaccine is given on or after 10/04/2023, evaluate it as INVALID/VACCINE_NO_LONGER_RECOMMENDED_ON_DATE_SPECIFIED"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	activation-group "allowableVaccineCheck"
	when
		There is an administered shot $currentShot that needs to be evaluated
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the vaccine administered a member of ("ICE211")
			- the administration date of the shot is >= "04-Oct-2023"
			- make note of the associated series as $targetSeries
	then
		Include the reason for shot $currentShot Invalid due to "Vaccine no longer recommended on date specified."
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $targetSeries
end

//////////////////////////////////////////////////////////////////////////////////////////////////
// END INVALID vaccines for Fall 2023-2024 Season
//////////////////////////////////////////////////////////////////////////////////////////////////


///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// START - "Skip dose" logic when Series is Not Complete
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


/*************************************************************************************************************************************************************************************
===> PRIOR FORMULATION of COVID-19 Vaccine Administered on or after 9/12/2023
    If a prior formulation of a COVID-19 vaccine, excluding CVX 211, is administered on or after 9/12/2023, then the Evaluation is Invalid and the reason code is
    VACCINE_NOT_ALLOWED_FOR_THIS_DOSE.
        + If administered as target dose 1 (for any Sept 2023 COVID-19 Series), recommended target dose 1 at shot date + 28 days, absolute minimum interval = 24 days.
        + If administered as other than target dose 1 (for any Sept 2023 COVID-19 Series), follow series intervals.
    If the prior formulation of Novavax (CVX 211) is administered on or after 10/4/2023, then the Evaluation is Invalid and reason code is VACCINE_NOT_ALLOWED_FOR_THIS_DOSE.
/************************************************************************************************************************************************************************************/


rule "COVID-19(Sep2023 Pfizer/Moderna/Mixed Product < 5yrs Series): If a shot was administered prior to target dose 1 (prior season) but has never received any (valid) doses, the absolute minimum interval from the prior shot to the current shot is 8w"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	activation-group "doseIntervalCheckFromPreviousSeason"
	no-loop true
	when
		There is an administered shot $currentShot that needs to be evaluated
			- the administration date of the shot is > "12-Sep-2023"
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the shot belongs to the Series with name a member of ("COVID19Sep2023gte5Series", "COVID19Sep2023PfizerLT5ySeries", "COVID19Sep2023ModernaLT5ySeries", "COVID19Sep2023MixedProductLT5ySeries")
			- make note of the date this shot was administered as $currentShotDate
			- make note of the associated series as $associatedTargetSeries
		There does not exist an administered shot
			- the administration date of the shot is < "12-Sep-2023"
		  - that has not already been evaluated
		There does not exist an IceFact
			- that has associated administered shot $currentShot
			- that has finding SupportedFactConcept._BELOW_MINIMUM_INTERVAL.conceptCodeValue
		There does not exist an administered shot
			- the shot belongs to the vaccine group "VACCINE_GROUP_CONCEPT.850"
			- the administration date of the shot is < "12-Sep-2023"
			- that has already been evaluated and whose shot validity is VALID
		There is an administered shot $previousShot
			- the shot belongs to the vaccine group "VACCINE_GROUP_CONCEPT.850"
			- the administration date of the shot is < "12-Sep-2023"
			- the shot is not ignored
			- make note of the date this shot was administered as $previousShotDate
		There does not exist an administered shot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the administration date of the shot is > $previousShotDate
			- the shot is not ignored
			- the administration date of the shot is < "12-Sep-2023"
		Confirm Elapsed time between $previousShotDate and $currentShotDate < "8w-4d"
	then
	  Set the shot status of $currentShot to Invalid
    Remove all evaluation reasons from shot $currentShot
		Include the reason for shot $currentShot Invalid due to "Below Minimum Interval"
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end

rule "COVID-19(Sep2023 Novavax Series): If the patient has 2 doses of 211 on or after 2023-09-12 but no doses of CVX 313, 8w-4d is the minimum interval"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	activation-group "doseIntervalCheckFromPreviousSeason"
	when
		There is an administered shot $currentShot that needs to be evaluated
			- the administration date of the shot is > "12-Sep-2023"
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the shot belongs to the Series with name a member of ("COVID19Sep2023NovavaxSeries")
			- the vaccine administered a member of ("ICE313")
			- make note of the date this shot was administered as $currentShotDate
			- make note of the associated series as $associatedTargetSeries
		There is a Series $targetSeries identified by $associatedTargetSeries
			- the number of administered shots is > 1
		There is an administered shot $latestShot
		  - the administration date of the shot is < $currentShotDate
		  - the vaccine administered a member of ("ICE211")
			- make note of the date this shot was administered as $latestShotDate
			- the shot is not ignored
		Confirm Elapsed time between $latestShotDate and $currentShotDate < "8w-4d"
	then
	  Set the shot status of $currentShot to Invalid
    Remove all evaluation reasons from shot $currentShot
		Include the reason for shot $currentShot Invalid due to "Below Minimum Interval"
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end

rule "COVID-19(Sep2023 Pfizer/Moderna/Mixed Product < 5yrs Series): If a shot was administered prior to target dose 1 (prior season) and the prior season's series is complete, the absolute minimum interval from the prior shot to the current shot is 8w-4d"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	activation-group "doseIntervalCheckFromPreviousSeason"
	no-loop true
	when
		There is an administered shot $currentShot that needs to be evaluated
			- the administration date of the shot is > "12-Sep-2023"
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the shot belongs to the Series with name a member of ("COVID19Sep2023PfizerLT5ySeries", "COVID19Sep2023ModernaLT5ySeries", "COVID19Sep2023MixedProductLT5ySeries")
			- make note of the date this shot was administered as $currentShotDate
			- make note of the associated series as $associatedTargetSeries
		There does not exist an administered shot
			- the administration date of the shot is < "12-Sep-2023"
		  - that has not already been evaluated
		There does not exist an IceFact
			- that has associated administered shot $currentShot
			- that has finding SupportedFactConcept._BELOW_MINIMUM_INTERVAL.conceptCodeValue
		There is a Series $priorSeasonSeries
			- the Series belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the Series belongs to the Season with Name "COVID19Dec2020Season"
			- the Series is complete
		There is an administered shot $previousShot
			- the shot belongs to the vaccine group "VACCINE_GROUP_CONCEPT.850"
			- the administration date of the shot is < "12-Sep-2023"
			- the shot is not ignored
			- make note of the date this shot was administered as $previousShotDate
		There does not exist an administered shot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the administration date of the shot is > $previousShotDate
			- the shot is not ignored
			- the administration date of the shot is < "12-Sep-2023"
		Confirm Elapsed time between $previousShotDate and $currentShotDate < "8w-4d"
	then
	  Set the shot status of $currentShot to Invalid
    Remove all evaluation reasons from shot $currentShot
		Include the reason for shot $currentShot Invalid due to "Below Minimum Interval"
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end


rule "COVID-19(Sep2023 Pfizer Product < 5yrs Series): If 2 valid pfizer shots were administered before, the absolute minimum interval from the prior shot to the current shot is 8w-4d"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	activation-group "doseIntervalCheckFromPreviousSeason"
	salience -2
	when
		There is an administered shot $currentShot that needs to be evaluated
			- the administration date of the shot is > "12-Sep-2023"
			- the shot belongs to the Series with name a member of ("COVID19Sep2023PfizerLT5ySeries")
			- make note of the date this shot was administered as $currentShotDate
			- make note of the associated series as $associatedTargetSeries
		There does not exist an IceFact
			- that has associated administered shot $currentShot
			- that has finding SupportedFactConcept._BELOW_MINIMUM_INTERVAL.conceptCodeValue
		There is an administered shot $previousShot
			- the vaccine administered a member of ("ICE208", "ICE217", "ICE218", "ICE219", "ICE300", "ICE301", "ICE302", "ICE520")
			- the administration date of the shot is < "12-Sep-2023"
			- the shot is not ignored
			- make note of the date this shot was administered as $previousShotDate
		There is an administered shot $previousShot2
    	- the vaccine administered a member of ("ICE208", "ICE217", "ICE218", "ICE219", "ICE300", "ICE301", "ICE302", "ICE520")
    	- the administration date of the shot is < $previousShotDate
			- the shot is not ignored
		Confirm Elapsed time between $previousShotDate and $currentShotDate < "8w-4d"
	then
	  Set the shot status of $currentShot to Invalid
		Include the reason for shot $currentShot Invalid due to "Below Minimum Interval"
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end


rule "COVID-19(Sep2023 Pfizer Product < 5yrs Series): If 1 valid pfizer shots was administered before, the absolute minimum interval from the prior shot to the current shot is 17 days"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	activation-group "doseIntervalCheckFromPreviousSeason"
	salience -3
	when
		There is an administered shot $currentShot that needs to be evaluated
			- the administration date of the shot is > "12-Sep-2023"
			- the shot belongs to the Series with name a member of ("COVID19Sep2023PfizerLT5ySeries")
			- make note of the date this shot was administered as $currentShotDate
			- make note of the associated series as $associatedTargetSeries
		There does not exist an IceFact
			- that has associated administered shot $currentShot
			- that has finding SupportedFactConcept._BELOW_MINIMUM_INTERVAL.conceptCodeValue
		There is an administered shot $previousShot
			- the vaccine administered a member of ("ICE208", "ICE217", "ICE218", "ICE219", "ICE300", "ICE301", "ICE302", "ICE520")
			- the administration date of the shot is < "12-Sep-2023"
			- the shot is not ignored
			- make note of the date this shot was administered as $previousShotDate
		Confirm Elapsed time between $previousShotDate and $currentShotDate < "17d"
	then
	  Set the shot status of $currentShot to Invalid
		Include the reason for shot $currentShot Invalid due to "Below Minimum Interval"
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end

rule "COVID-19(Sep2023 Moderna Product < 5yrs Series): If 1 moderna valid shot was administered before, the absolute minimum interval from the prior shot to the current shot is 24d"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	activation-group "doseIntervalCheckFromPreviousSeason"
	salience -4
	when
		There is an administered shot $currentShot that needs to be evaluated
			- the administration date of the shot is > "12-Sep-2023"
			- the shot belongs to the Series with name a member of ("COVID19Sep2023ModernaLT5ySeries")
			- make note of the date this shot was administered as $currentShotDate
			- make note of the associated series as $associatedTargetSeries
		There does not exist an IceFact
			- that has associated administered shot $currentShot
			- that has finding SupportedFactConcept._BELOW_MINIMUM_INTERVAL.conceptCodeValue
		There is an administered shot $previousShot
			- the vaccine administered a member of ("ICE207", "ICE221", "ICE227", "ICE228", "ICE229", "ICE230", "ICE519")
			- the administration date of the shot is < "12-Sep-2023"
			- that has already been evaluated and whose shot validity is VALID
		There is an administered shot $latestPreviousShot
		  - the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
		  - the administration date of the shot is < "12-Sep-2023"
			- the shot is not ignored
			- make note of the date this shot was administered as $latestSeasonShotDate
		There does not exist an administered shot
		  - the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
		  - the administration date of the shot is < "12-Sep-2023"
			- the shot is not ignored
		  - the administration date of the shot is > $latestSeasonShotDate
		Confirm Elapsed time between $latestSeasonShotDate and $currentShotDate < "24d"
	then
	  Set the shot status of $currentShot to Invalid
		Include the reason for shot $currentShot Invalid due to "Below Minimum Interval"
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end


rule "COVID-19(Sep2023 Moderna/Mixed Product < 5yrs Series): If 2 valid shots were administered before, the absolute minimum interval from the prior shot to the current shot is 8w-4d"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	activation-group "doseIntervalCheckFromPreviousSeason"
	when
		There is an administered shot $currentShot
			- the administration date of the shot is > "12-Sep-2023"
			- the shot belongs to the Series with name a member of ("COVID19Sep2023MixedProductLT5ySeries", "COVID19Sep2023ModernaLT5ySeries")
			- make note of the date this shot was administered as $currentShotDate
			- make note of the associated series as $associatedTargetSeries
		There does not exist an IceFact
			- that has associated administered shot $currentShot
			- that has finding SupportedFactConcept._BELOW_MINIMUM_INTERVAL.conceptCodeValue
		There is an administered shot $previousShot1
			- the vaccine administered a member of ("ICE207", "ICE208", "ICE210", "ICE211", "ICE212", "ICE213", "ICE217", "ICE218", "ICE219", "ICE221", "ICE227", "ICE228", "ICE229", "ICE230", "ICE300", "ICE301", "ICE302", "ICE502", "ICE510", "ICE511", "ICE519", "ICE520")
			- the administration date of the shot is < "12-Sep-2023"
			- that has already been evaluated and whose shot validity is VALID
			- make note of the date this shot was administered as $administrationDate1
		There is an administered shot $previousShot2
			- the vaccine administered a member of ("ICE207", "ICE208", "ICE210", "ICE211", "ICE212", "ICE213", "ICE217", "ICE218", "ICE219", "ICE221", "ICE227", "ICE228", "ICE229", "ICE230", "ICE300", "ICE301", "ICE302", "ICE502", "ICE510", "ICE511", "ICE519", "ICE520")
			- the administration date of the shot is < "12-Sep-2023"
			- the administration date of the shot is != $administrationDate1
			- that has already been evaluated and whose shot validity is VALID
		There is an administered shot $latestPreviousShot
		  - the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
		  - the administration date of the shot is < "12-Sep-2023"
			- the shot is not ignored
			- make note of the date this shot was administered as $latestSeasonShotDate
		There does not exist an administered shot
		  - the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
		  - the administration date of the shot is < "12-Sep-2023"
			- the shot is not ignored
		  - the administration date of the shot is > $latestSeasonShotDate
		Confirm Elapsed time between $latestSeasonShotDate and $currentShotDate < "8w-4d"
	then
	  Set the shot status of $currentShot to Invalid
	  Refresh all facts in the shot $currentShot
		Include the reason for shot $currentShot Invalid due to "Below Minimum Interval"
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end


rule "COVID-19(Sep2023 Mixed Product < 5yrs Series): If 1 valid shot was administered before, the absolute minimum interval from the prior shot to the current shot is 24d"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	activation-group "doseIntervalCheckFromPreviousSeason"
	salience -5
	when
		There is an administered shot $currentShot that needs to be evaluated
			- the administration date of the shot is > "12-Sep-2023"
			- the shot belongs to the Series with name a member of ("COVID19Sep2023MixedProductLT5ySeries")
			- make note of the date this shot was administered as $currentShotDate
			- make note of the associated series as $associatedTargetSeries
		There does not exist an IceFact
			- that has associated administered shot $currentShot
			- that has finding SupportedFactConcept._BELOW_MINIMUM_INTERVAL.conceptCodeValue
		There is an administered shot $previousShot1
			- the vaccine administered a member of ("ICE207", "ICE208", "ICE210", "ICE211", "ICE212", "ICE213", "ICE217", "ICE218", "ICE219", "ICE221", "ICE227", "ICE228", "ICE229", "ICE230", "ICE300", "ICE301", "ICE302", "ICE502", "ICE510", "ICE511", "ICE519", "ICE520")
			- the administration date of the shot is < "12-Sep-2023"
			- that has already been evaluated and whose shot validity is VALID
		There is an administered shot $latestPreviousShot
		  - the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
		  - the administration date of the shot is < "12-Sep-2023"
			- the shot is not ignored
			- make note of the date this shot was administered as $latestSeasonShotDate
		There does not exist an administered shot
		  - the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
		  - the administration date of the shot is < "12-Sep-2023"
			- the shot is not ignored
		  - the administration date of the shot is > $latestSeasonShotDate
		Confirm Elapsed time between $latestSeasonShotDate and $currentShotDate < "24d"
	then
	  Set the shot status of $currentShot to Invalid
	  Refresh all facts in the shot $currentShot
		Include the reason for shot $currentShot Invalid due to "Below Minimum Interval"
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end


rule "COVID-19(Sep2023 COVID >= 5yrs Series): If 1 valid shot was administered before, the absolute minimum interval from the prior shot to the current shot is 8w-4d"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	activation-group "doseIntervalCheckFromPreviousSeason"
	salience -6
	when
		There is an administered shot $currentShot that needs to be evaluated
			- the shot belongs to the Series with name a member of ("COVID19Sep2023gte5Series")
			- make note of the date this shot was administered as $currentShotDate
			- make note of the associated series as $associatedTargetSeries
		There does not exist an IceFact
			- that has associated administered shot $currentShot
			- that has finding SupportedFactConcept._BELOW_MINIMUM_INTERVAL.conceptCodeValue
		There is an administered shot $previousShot
		  - the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the administration date of the shot is < $currentShotDate
			- the shot is not ignored
			- make note of the date this shot was administered as $previousShotDate
		Confirm Elapsed time between $previousShotDate and $currentShotDate < "8w-4d"
	then
	  Set the shot status of $currentShot to Invalid
		Include the reason for shot $currentShot Invalid due to "Below Minimum Interval"
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end


rule "COVID-19(COVID19Sep2023gte5Series): If a CVX 313 was the only dose on record. Absolute minimum interval to a mRNA CVX (CVX 213, CVX 309, CVX 310, CVX 311, CVX 312) = 8 weeks minus 4 days"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	activation-group "doseIntervalCheck"
	salience 999
	when
		There is an administered shot $currentShot that needs to be evaluated
		  - the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
		  - the vaccine administered a member of ("ICE213", "ICE309", "ICE310", "ICE311", "ICE312")
      - the administration date of the shot is >= "12-Sep-2023"
      - make note of the associated series as $associatedTargetSeries
  		- make note of the date this shot was administered as $currentShotDate
    There is a Series $targetSeries identified by $associatedTargetSeries
     	- the name of the Series a member of ("COVID19Sep2023gte5Series")
		There does not exist an IceFact
			- that has associated administered shot $currentShot
			- that has finding SupportedFactConcept._BELOW_MINIMUM_INTERVAL.conceptCodeValue
		There is an administered shot $latestPreviousShot
		  - the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
		  - the vaccine administered a member of ("ICE313")
      - the administration date of the shot is >= "12-Sep-2023"
		  - the administration date of the shot is < $currentShotDate
			- that has already been evaluated and whose shot validity is VALID
  		- make note of the date this shot was administered as $previousShotDate
		There does not exist an administered shot
		  - the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
		  - the administration date of the shot is < $previousShotDate
			- that has already been evaluated and whose shot validity is VALID
		Confirm Elapsed time between $previousShotDate and $currentShotDate < "8w-4d"
	then
	  Set the shot status of $currentShot to Invalid
	  Refresh all facts in the shot $currentShot
		Include the reason for shot $currentShot Invalid due to "Below Minimum Interval"
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end

rule "COVID-19(COVID19Sep2023gte5Series): If series was completed due to special rule, remove duplicate after 313"
	dialect "mvel"
	agenda-group "HistoryEvaluation^postEvaluationCheck"
	activation-group "doseIntervalCheck"
	salience 998
	when
		There is an administered shot $currentShot
		  - the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
		  - the vaccine administered a member of ("ICE213", "ICE309", "ICE310", "ICE311", "ICE312", "ICE313")
      - the administration date of the shot is >= "12-Sep-2023"
      - that has already been evaluated and whose shot validity is ACCEPTED
      - make note of the associated series as $associatedTargetSeries
  		- make note of the date this shot was administered as $currentShotDate
    There is a Series $targetSeries identified by $associatedTargetSeries
     	- the name of the Series a member of ("COVID19Sep2023gte5Series")
    	- This rule "specialDoseRuleCompleteSeries" has not been executed before for this series
		There does not exist an IceFact
			- that has associated administered shot $currentShot
			- that has finding SupportedFactConcept._BELOW_MINIMUM_INTERVAL.conceptCodeValue
		There is an administered shot $latestPreviousShot
		  - the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
		  - the vaccine administered a member of ("ICE313")
      - the administration date of the shot is >= "12-Sep-2023"
		  - the administration date of the shot is < $currentShotDate
			- that has already been evaluated and whose shot validity is VALID
  		- make note of the date this shot was administered as $previousShotDate
		There does not exist an administered shot
		  - the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
		  - the vaccine administered a member of ("ICE213", "ICE309", "ICE310", "ICE311", "ICE312")
      - the administration date of the shot is >= "12-Sep-2023"
      - the administration date of the shot is < $currentShotDate
      - that has already been evaluated and whose shot validity is ACCEPTED
		There does not exist an administered shot
		  - the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
		  - the administration date of the shot is < $previousShotDate
			- that has already been evaluated and whose shot validity is VALID
		Confirm Elapsed time between $previousShotDate and $currentShotDate >= "8w-4d"
	then
	  Set the shot status of $currentShot to Valid
	  Refresh all facts in the shot $currentShot
		Record that the Series rule "specialDoseRuleCompleteSeries" was Processed for the TargetSeries $associatedTargetSeries
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end


rule "COVID-19(Sep2023 Novavax Series): If the patient has 2 doses of 211 on or after 2023-09-12 and then one of CVX 313, the series is complete no extra dose"
	dialect "mvel"
	agenda-group "HistoryEvaluation^postEvaluationCheck"
	no-loop true
	when
		There is an administered shot $currentShot
			- the administration date of the shot is > "12-Sep-2023"
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the shot belongs to the Series with name a member of ("COVID19Sep2023NovavaxSeries")
			- the vaccine administered a member of ("ICE313")
			- that has already been evaluated and whose shot validity is ACCEPTED
			- make note of the date this shot was administered as $currentShotDate
			- make note of the associated series as $associatedTargetSeries
		There does not exist an administered shot
		  - the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the vaccine administered a member of ("ICE313")
			- the shot belongs to the Series with name a member of ("COVID19Sep2023NovavaxSeries")
		  - the administration date of the shot is > $currentShotDate
			- that has already been evaluated and whose shot validity is ACCEPTED
		There is a Series $targetSeries identified by $associatedTargetSeries
			- the number of administered shots is > 1
		There is an administered shot $shot1
		  - the administration date of the shot is < $currentShotDate
		  - the vaccine administered a member of ("ICE211")
			- the shot is not ignored
		There is an administered shot $shot2
		  - that is not the same shot as $shot1
		  - the administration date of the shot is < $currentShotDate
		  - the vaccine administered a member of ("ICE211")
			- the shot is not ignored
	then
	  Set the shot status of $currentShot to Valid
    Remove all evaluation reasons from shot $currentShot
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $associatedTargetSeries
end

/*************************************************************************************************************************************************************************************
 END - PRIOR FORMULATION of COVID-19 Vaccine Administered on or after 9/12/2023
/************************************************************************************************************************************************************************************/


/*************************************************************************************************************************************************************************************
 ___SKIP DOSE RULES___
 ===> Series: Pfizer < 5ys, Moderna < 5yrs
 ===> __SKIP DOSE__ Rules FOR patients < 5 yrs of age in series

 * Target Dose 1
    + If the patient has 1 dose of any of the following prior formulations vaccines (CVX 207, CVX 208, CVX 217, CVX 218, CVX 219, CVX 221, CVX 227, CVX 228, CVX 229, CVX 230,
      CVX 300, CVX 301, CVX 302, or CVX 520) administered prior to 9/12/2023, target dose 1 is not needed. Skip to target dose 2.
    + For the Moderna series, if skipped to target dose 2 and there are 2 or doses in the prior season, the following intervals apply:
        = Absolute minimum interval = 8 weeks - 4 days
        = Minimum interval = 8 weeks
        = Recommended interval = 8 weeks

 * Target Dose 1 and Target Dose 2
    + If the patient has >= 2 doses of any of the following following prior formulations vaccines (CVX 207, CVX 208, CVX 217, CVX 218, CVX 219, CVX 221, CVX 227, CVX 228, CVX 229,
      CVX 230, CVX 300, CVX 301, CVX 302, or CVX 520) administered prior to 9/12/2023, target dose 1 and target dose 2 are not needed. Skip to target dose 3.
/************************************************************************************************************************************************************************************/

rule "COVID-19(Abstract): Previous valid shot before 2023 Fall season Moderna and Pfizer Series < 5 years"
	dialect "mvel"
	agenda-group "HistoryEvaluation^postEvaluationCheck"
	salience -1
	when
	  There is an administered shot $currentShot
      - the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
      - the vaccine administered a member of ("ICE308", "ICE309", "ICE310", "ICE311", "ICE312")
      - the administration date of the shot is >= "12-Sep-2023"
      - that has already been evaluated and whose shot validity is VALID
      - make note of the associated series as $associatedTargetSeries
      - make note of the date this shot was administered as $currentShotAdministrationDate
    There is a Series $targetSeries identified by $associatedTargetSeries
    	- the name of the Series a member of ("COVID19Sep2023ModernaLT5ySeries", "COVID19Sep2023PfizerLT5ySeries")
    	- This rule "specialDoseRuleCompleteSeries" has not been executed before for this series
		There is an administered shot $previousShot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the administration date of the shot is < "12-Sep-2023"
			- that has already been evaluated and whose shot validity is VALID
		There does not exist an Administered Shot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
		  - that has not already been evaluated
	then
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this Series Rule fired for the Series $targetSeries
end


rule "COVID-19(COVID19Sep2023LT5ySeries): Previous valid shot before 2023 Fall season Pfizer Series < 5 years previous 2 valid shots before Fall 2023"
	extends "COVID-19(Abstract): Previous valid shot before 2023 Fall season Moderna and Pfizer Series < 5 years"
	dialect "mvel"
	agenda-group "HistoryEvaluation^postEvaluationCheck"
	activation-group "specialDoseRulesCheck"
	salience -1
	when
	  There is an administered shot $targetShot identified by $currentShot
      - the vaccine administered a member of ("ICE308", "ICE309", "ICE310")
      - the administration date of the shot is >= "12-Sep-2023"
      - Make note of the administered shot number as $currentShotNumber
    // May need to add a "There is no other valid administered shot before this current shot of the series"
    There is a Series $currentSeries identified by $associatedTargetSeries
    	- the name of the Series a member of ("COVID19Sep2023PfizerLT5ySeries")
		There is an administered shot $previousShot1
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the vaccine administered a member of ("ICE208", "ICE217", "ICE218", "ICE219", "ICE300", "ICE301", "ICE302", "ICE520")
			- the administration date of the shot is < "12-Sep-2023"
			- that has already been evaluated and whose shot validity is VALID
			- make note of the date this shot was administered as $administrationDate1
		There is an administered shot $previousShot2
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the vaccine administered a member of ("ICE208", "ICE217", "ICE218", "ICE219", "ICE300", "ICE301", "ICE302", "ICE520")
			- the administration date of the shot is < "12-Sep-2023"
			- that has already been evaluated and whose shot validity is VALID
			- the administration date of the shot is != $administrationDate1
	then
	  Mark the Series $associatedTargetSeries complete
	  Set the shots of the series $associatedTargetSeries after the dose number of $currentShotNumber to accepted due to "Extra Dose"
		Record that this dose rule was Processed for the TargetDose $currentShot
		Record that the Series rule "specialDoseRuleCompleteSeries" was Processed for the TargetSeries $associatedTargetSeries
		Log that this Dose Rule fired for the Dose $currentShot in the Series $associatedTargetSeries
end


rule "COVID-19(COVID19Sep2023LT5ySeries): Previous valid shot before 2023 Fall season Pfizer Series < 5 years previous 1 valid shot before Fall 2023"
	extends "COVID-19(Abstract): Previous valid shot before 2023 Fall season Moderna and Pfizer Series < 5 years"
	dialect "mvel"
	agenda-group "HistoryEvaluation^postEvaluationCheck"
	activation-group "specialDoseRulesCheck"
	salience -2
	when
	  There is an administered shot $targetShot identified by $currentShot
      - the vaccine administered a member of ("ICE308", "ICE309", "ICE310")
      - the administration date of the shot is >= "12-Sep-2023"
      - Make note of the administered shot number as $currentShotNumber
    There is a Series $currentSeries identified by $associatedTargetSeries
    	- the name of the Series a member of ("COVID19Sep2023PfizerLT5ySeries")
    There is an administered shot $previousSeriesShot
      - the shot belongs to the series $associatedTargetSeries
      - the administration date of the shot is < $currentShotAdministrationDate
      - that has already been evaluated and whose shot validity is VALID
		There is an administered shot $previousSeasonShot1
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the vaccine administered a member of ("ICE208", "ICE217", "ICE218", "ICE219", "ICE300", "ICE301", "ICE302", "ICE520")
			- the administration date of the shot is < "12-Sep-2023"
			- that has already been evaluated and whose shot validity is VALID
			- make note of the date this shot was administered as $administrationDate1
    Verify that the count of doses administered in series $associatedTargetSeries with vaccine a member of ("ICE308", "ICE309", "ICE310") is > 1
	then
	  Mark the Series $associatedTargetSeries complete
	  Set the shots of the series $associatedTargetSeries after the dose number of $currentShotNumber to accepted due to "Extra Dose"
		Record that this dose rule was Processed for the TargetDose $currentShot
		Record that the Series rule "specialDoseRuleCompleteSeries" was Processed for the TargetSeries $associatedTargetSeries
		Log that this Series Rule fired for the Series $associatedTargetSeries
end


rule "COVID-19(COVID19Sep2023LT5ySeries): If the patient has 1 dose of updated Sept 2023 Pfizer COVID-19 vaccine intended for patients age >= 5 years (CVX 309 or CVX 310) at age >= 5 years, then the series is complete"
	dialect "mvel"
	agenda-group "HistoryEvaluation^postEvaluationCheck"
	activation-group "specialDoseRulesCheck"
	salience -2
	when
	  The patient information $oEvaluatedPerson must be known to complete writing this rule
      - make note of the date as $dateAt5yOfAge when the patient is "5y" of age
	  There is an administered shot $currentShot
      - the vaccine administered a member of ("ICE309", "ICE310")
      - the administration date of the shot is >= "12-Sep-2023"
      - the administration date of the shot is >= $dateAt5yOfAge
      - that has already been evaluated and whose shot validity is VALID
      - Make note of the administered shot number as $currentShotNumber
      - Make note of the date this shot was administered as $currentAdministeredDate
      - make note of the associated series as $associatedTargetSeries
    There is a Series $currentSeries identified by $associatedTargetSeries
    	- the name of the Series a member of ("COVID19Sep2023PfizerLT5ySeries")
    	- This rule "specialDoseRuleCompleteSeries" has not been executed before for this series
    There does not exist an administered shot
      - the vaccine administered a member of ("ICE309", "ICE310")
      - the administration date of the shot is >= "12-Sep-2023"
      - that has already been evaluated and whose shot validity is VALID
      - the administration date of the shot is < $currentAdministeredDate
      - the administration date of the shot is >= $dateAt5yOfAge
	then
	  Mark the Series $associatedTargetSeries complete
	  Set the shots of the series $associatedTargetSeries after the dose number of $currentShotNumber to accepted due to "Extra Dose"
		Record that this dose rule was Processed for the TargetDose $currentShot
		Record that the Series rule "specialDoseRuleCompleteSeries" was Processed for the TargetSeries $associatedTargetSeries
		Log that this Series Rule fired for the Series $associatedTargetSeries
end


rule "COVID-19(ModernaSeries): Previous valid shot before 2023 Fall season Moderna Series < 5 years previous 1 valid shots before Fall 2023"
	extends "COVID-19(Abstract): Previous valid shot before 2023 Fall season Moderna and Pfizer Series < 5 years"
	dialect "mvel"
	agenda-group "HistoryEvaluation^postEvaluationCheck"
	activation-group "specialDoseRulesCheck"
	salience -1
	when
	  There is an administered shot $targetShot identified by $currentShot
      - the vaccine administered a member of ("ICE311", "ICE312")
      - the administration date of the shot is >= "12-Sep-2023"
      - Make note of the administered shot number as $currentShotNumber
    // May need to add a "There is no other valid administered shot before this current shot of the series"
    There is a Series $currentSeries identified by $associatedTargetSeries
    	- the name of the Series a member of ("COVID19Sep2023ModernaLT5ySeries")
		There is an administered shot $previousShot1
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the vaccine administered a member of ("ICE207", "ICE221", "ICE227", "ICE228", "ICE229", "ICE230", "ICE519")
			- the administration date of the shot is < "12-Sep-2023"
			- that has already been evaluated and whose shot validity is VALID
			- make note of the date this shot was administered as $administrationDate1
	then
	  Mark the Series $currentSeries complete
	  Set the shots of the series $currentSeries after the dose number of $currentShotNumber to accepted due to "Extra Dose"
		Record that this dose rule was Processed for the TargetDose $targetShot
		Record that the Series rule "specialDoseRuleCompleteSeries" was Processed for the TargetSeries $currentSeries
		Log that this Dose Rule fired for the Dose $targetShot in the Series $currentSeries
end

rule "COVID-19(Mixed Product Series): Previous valid 2 shots before 2023 Fall season Mixed product Series < 5 years"
	dialect "mvel"
	agenda-group "HistoryEvaluation^postEvaluationCheck"
	activation-group "specialDoseRulesCheck"
	salience -1
	when
	  There is an administered shot $currentShot
      - the vaccine administered a member of ("ICE213", "ICE308", "ICE309", "ICE310", "ICE311", "ICE312", "ICE313")
      - the administration date of the shot is >= "12-Sep-2023"
      - that has already been evaluated and whose shot validity is VALID
      - make note of the associated series as $associatedTargetSeries
      - Make note of the administered shot number as $currentShotNumber
    There is a Series $targetSeries identified by $associatedTargetSeries
    	- the name of the Series a member of ("COVID19Sep2023MixedProductLT5ySeries")
    	- This rule "specialDoseRuleCompleteSeries" has not been executed before for this series
		There is an administered shot $previousShot1
      - the vaccine administered a member of ("ICE207", "ICE208", "ICE210", "ICE211", "ICE212", "ICE213", "ICE217", "ICE218", "ICE219", "ICE221", "ICE227", "ICE228", "ICE229", "ICE230", "ICE300", "ICE301", "ICE302", "ICE502", "ICE510", "ICE511", "ICE519", "ICE520")
			- the administration date of the shot is < "12-Sep-2023"
			- that has already been evaluated and whose shot validity is VALID
			- make note of the date this shot was administered as $administrationDate1
		There is an administered shot $previousShot2
			- the vaccine administered a member of ("ICE207", "ICE208", "ICE210", "ICE211", "ICE212", "ICE213", "ICE217", "ICE218", "ICE219", "ICE221", "ICE227", "ICE228", "ICE229", "ICE230", "ICE300", "ICE301", "ICE302", "ICE502", "ICE510", "ICE511", "ICE519", "ICE520")
			- the administration date of the shot is < "12-Sep-2023"
			- that has already been evaluated and whose shot validity is VALID
			- the administration date of the shot is != $administrationDate1
	then
	  Mark the Series $associatedTargetSeries complete
	  Set the shots of the series $associatedTargetSeries after the dose number of $currentShotNumber to accepted due to "Extra Dose"
		Record that this dose rule was Processed for the TargetDose $currentShot
		Record that the Series rule "specialDoseRuleCompleteSeries" was Processed for the TargetSeries $associatedTargetSeries
		Log that this Series Rule fired for the Series $associatedTargetSeries
end

rule "COVID-19(Mixed Product Series): Previous valid 1 shot before 2023 Fall season Mixed product Series < 5 years"
	dialect "mvel"
	agenda-group "HistoryEvaluation^postEvaluationCheck"
	activation-group "specialDoseRulesCheck"
	salience -2
	when
	  There is an administered shot $currentShot
      - the vaccine administered a member of ("ICE213", "ICE308", "ICE309", "ICE310", "ICE311", "ICE312", "ICE313")
      - the administration date of the shot is >= "12-Sep-2023"
      - that has already been evaluated and whose shot validity is VALID
      - make note of the associated series as $associatedTargetSeries
      - Make note of the administered shot number as $currentShotNumber
			- make note of the date this shot was administered as $currentShotDate
    There is a Series $targetSeries identified by $associatedTargetSeries
    	- the name of the Series a member of ("COVID19Sep2023MixedProductLT5ySeries")
    	- This rule "specialDoseRuleCompleteSeries" has not been executed before for this series
		There is an administered shot $previousShot1
      - the vaccine administered a member of ("ICE207", "ICE208", "ICE210", "ICE211", "ICE212", "ICE213", "ICE217", "ICE218", "ICE219", "ICE221", "ICE227", "ICE228", "ICE229", "ICE230", "ICE300", "ICE301", "ICE302", "ICE502", "ICE510", "ICE511", "ICE519", "ICE520")
			- the administration date of the shot is < "12-Sep-2023"
			- that has already been evaluated and whose shot validity is VALID
		There is an administered shot $previousShotInSeries
		  - the vaccine administered a member of ("ICE213", "ICE308", "ICE309", "ICE310", "ICE311", "ICE312")
		  - the administration date of the shot is >= "12-Sep-2023"
		  - the administration date of the shot is < $currentShotDate
      - that has already been evaluated and whose shot validity is VALID
      - make note of the date this shot was administered as $earliestValidShotDateInSeries
    There does not exist an administered shot
		  - the vaccine administered a member of ("ICE213", "ICE308", "ICE309", "ICE310", "ICE311", "ICE312")
      - the administration date of the shot is >= "12-Sep-2023"
      - that has already been evaluated and whose shot validity is VALID
		  - the administration date of the shot is < $earliestValidShotDateInSeries
    There does not exist an administered shot
		  - the vaccine administered a member of ("ICE213", "ICE308", "ICE309", "ICE310", "ICE311", "ICE312")
      - the administration date of the shot is >= "12-Sep-2023"
      - that has already been evaluated and whose shot validity is VALID
		  - the administration date of the shot is > $earliestValidShotDateInSeries
		  - the administration date of the shot is < $currentShotDate
	then
	  Mark the Series $associatedTargetSeries complete
	  Set the shots of the series $associatedTargetSeries after the dose number of $currentShotNumber to accepted due to "Extra Dose"
		Record that this dose rule was Processed for the TargetDose $currentShot
		Record that the Series rule "specialDoseRuleCompleteSeries" was Processed for the TargetSeries $associatedTargetSeries
		Log that this Series Rule fired for the Series $associatedTargetSeries
end

rule "COVID-19(Mixed Product Series): Only 2 valid doses of CVX 313 is needed for series to be complete"
	dialect "mvel"
	agenda-group "HistoryEvaluation^postEvaluationCheck"
	activation-group "specialDoseRulesCheck"
	when
	  There is an administered shot $currentShot
      - the vaccine administered a member of ("ICE313")
      - the administration date of the shot is >= "12-Sep-2023"
      - that has already been evaluated and whose shot validity is VALID
      - make note of the associated series as $associatedTargetSeries
			- make note of the date this shot was administered as $currentShotDate
      - Make note of the administered shot number as $currentShotNumber
    There is a Series $targetSeries identified by $associatedTargetSeries
    	- the name of the Series a member of ("COVID19Sep2023MixedProductLT5ySeries")
    	- This rule "specialDoseRuleCompleteSeries" has not been executed before for this series
		There is an administered shot $previousShotInSeries
      - the vaccine administered a member of ("ICE313")
			- the administration date of the shot is >= "12-Sep-2023"
			- that has already been evaluated and whose shot validity is VALID
			- the administration date of the shot is < $currentShotDate
      - make note of the date this shot was administered as $earliestValidShotDateInSeries
    There does not exist an administered shot
      - the administration date of the shot is >= "12-Sep-2023"
      - the vaccine administered a member of ("ICE313")
      - that has already been evaluated and whose shot validity is VALID
		  - the administration date of the shot is < $earliestValidShotDateInSeries
    There does not exist an administered shot
      - the administration date of the shot is >= "12-Sep-2023"
      - the vaccine administered a member of ("ICE313")
      - that has already been evaluated and whose shot validity is VALID
		  - the administration date of the shot is > $earliestValidShotDateInSeries
		  - the administration date of the shot is < $currentShotDate
	then
	  Mark the Series $associatedTargetSeries complete
	  Set the shots of the series $associatedTargetSeries after the dose number of $currentShotNumber to accepted due to "Extra Dose"
		Record that this dose rule was Processed for the TargetDose $currentShot
		Record that the Series rule "specialDoseRuleCompleteSeries" was Processed for the TargetSeries $associatedTargetSeries
		Log that this Series Rule fired for the Series $associatedTargetSeries
end

rule "COVID-19(Mixed Product Series): If the patient has 1 dose of updated Pfizer or Moderna Sept 2023 COVID-19 vaccine intended for patients age >= 5 years (CVX 309, CVX 310, CVX 311, or CVX 312) at age >= 5 years, then the series is complete"
	dialect "mvel"
	agenda-group "HistoryEvaluation^postEvaluationCheck"
	activation-group "specialDoseRulesCheck"
	salience -2
	when
	  The patient information $oEvaluatedPerson must be known to complete writing this rule
      - make note of the date as $dateAt5yOfAge when the patient is "5y" of age
	  There is an administered shot $currentShot
      - the vaccine administered a member of ("ICE309", "ICE310", "ICE311", "ICE312")
      - the administration date of the shot is >= "12-Sep-2023"
      - the administration date of the shot is >= $dateAt5yOfAge
      - that has already been evaluated and whose shot validity is VALID
      - make note of the associated series as $associatedTargetSeries
			- make note of the date this shot was administered as $currentShotDate
      - Make note of the administered shot number as $currentShotNumber
    There is a Series $targetSeries identified by $associatedTargetSeries
    	- the name of the Series a member of ("COVID19Sep2023MixedProductLT5ySeries")
    	- This rule "specialDoseRuleCompleteSeries" has not been executed before for this series
    There does not exist an administered shot
      - the administration date of the shot is >= $dateAt5yOfAge
      - the administration date of the shot is >= "12-Sep-2023"
      - the vaccine administered a member of ("ICE309", "ICE310", "ICE311", "ICE312")
      - that has already been evaluated and whose shot validity is VALID
		  - the administration date of the shot is < $currentShotDate
	then
	  Mark the Series $associatedTargetSeries complete
	  Set the shots of the series $associatedTargetSeries after the dose number of $currentShotNumber to accepted due to "Extra Dose"
		Record that this dose rule was Processed for the TargetDose $currentShot
		Record that the Series rule "specialDoseRuleCompleteSeries" was Processed for the TargetSeries $associatedTargetSeries
		Log that this Series Rule fired for the Series $associatedTargetSeries
end

rule "COVID-19(Mixed Product Series): If the patient has >= 1 dose of COVID-19 vaccine at age < 5 years and has 1 dose of updated Novavax Sept 2023 COVID-19 vaccine (CVX 313) at age >= 5 years, then the series is complete"
	dialect "mvel"
	agenda-group "HistoryEvaluation^postEvaluationCheck"
	activation-group "specialDoseRulesCheck"
	when
	  The patient information $oEvaluatedPerson must be known to complete writing this rule
      - make note of the date as $dateAt5yOfAge when the patient is "5y" of age
	  There is an administered shot $currentShot
      - the vaccine administered a member of ("ICE313")
      - the administration date of the shot is >= "12-Sep-2023"
      - the administration date of the shot is >= $dateAt5yOfAge
      - that has already been evaluated and whose shot validity is VALID
      - make note of the associated series as $associatedTargetSeries
			- make note of the date this shot was administered as $currentShotDate
      - Make note of the administered shot number as $currentShotNumber
    There is a Series $targetSeries identified by $associatedTargetSeries
    	- the name of the Series a member of ("COVID19Sep2023MixedProductLT5ySeries")
    	- This rule "specialDoseRuleCompleteSeries" has not been executed before for this series
    There does not exist an administered shot
      - the administration date of the shot is >= $dateAt5yOfAge
      - the administration date of the shot is >= "12-Sep-2023"
      - the vaccine administered a member of ("ICE313")
      - that has already been evaluated and whose shot validity is VALID
		  - the administration date of the shot is < $currentShotDate
		There is an administered shot $previousShotBefore5y
			- the shot belongs to the vaccine group "VACCINE_GROUP_CONCEPT.850"
			- that has already been evaluated and whose shot validity is VALID
			- the administration date of the shot is < $dateAt5yOfAge
	then
	  Mark the Series $associatedTargetSeries complete
	  Set the shots of the series $associatedTargetSeries after the dose number of $currentShotNumber to accepted due to "Extra Dose"
		Record that this dose rule was Processed for the TargetDose $currentShot
		Record that the Series rule "specialDoseRuleCompleteSeries" was Processed for the TargetSeries $associatedTargetSeries
		Log that this Series Rule fired for the Series $associatedTargetSeries
end

rule "COVID-19: If a Novavax 211 vaccine is given between 9/12/2023 and 10/04/2023 and the series is gte 5 years old evaluate it as ACCEPTED/VACCINE_NOT_PART_OF_THIS_SERIES"
	dialect "mvel"
	agenda-group "HistoryEvaluation^customEvaluationRule"
	activation-group "doseIntervalCheckFromPreviousSeason"
	salience -100
	when
		There is an administered shot $currentShot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
			- the vaccine administered a member of ("ICE211")
			- the shot belongs to the Series with name a member of ("COVID19Sep2023gte5Series")
			- the administration date of the shot is >= "12-Sep-2023"
			- the administration date of the shot is < "04-Oct-2023"
			- make note of the associated series as $targetSeries
	then
		Include the reason for shot $currentShot Accepted due to "Vaccine Not Part of This Series"
		Record that this dose rule was Processed for the TargetDose $currentShot
		Log that this dose rule fired for the dose $currentShot in the Series $targetSeries
end

rule "COVID-19(COVID19Sep2023gte5Series): If a CVX 313 is the only dose on record, the series is not complete"
	dialect "mvel"
	agenda-group "RecommendationForecast^customRecommendationRule"
	salience 999
	when
	  There is an administered shot $currentShot
      - the vaccine administered a member of ("ICE313")
      - the administration date of the shot is >= "12-Sep-2023"
      - that has already been evaluated and whose shot validity is VALID
      - make note of the associated series as $associatedTargetSeries
			- make note of the date this shot was administered as $currentShotDate
    There is a Series $targetSeries identified by $associatedTargetSeries
    	- the name of the Series a member of ("COVID19Sep2023gte5Series")
    	- This rule "specialDoseRuleNOTCompleteSeries" has not been executed before for this series
		There does not exist an Administered Shot
			- the shot belongs to the Vaccine Group "VACCINE_GROUP_CONCEPT.850"
		  - that has not already been evaluated
    There does not exist an administered shot
			- the shot belongs to the vaccine group "VACCINE_GROUP_CONCEPT.850"
      - that has already been evaluated and whose shot validity is VALID or ACCEPTED
		  - the administration date of the shot is < $currentShotDate
    There does not exist an administered shot
			- the shot belongs to the vaccine group "VACCINE_GROUP_CONCEPT.850"
      - that has already been evaluated and whose shot validity is VALID or ACCEPTED
		  - the administration date of the shot is > $currentShotDate
	then
	  Manually Mark the Series $associatedTargetSeries Not Complete
		Record that this dose rule was Processed for the TargetDose $currentShot
		Record that the Series rule "specialDoseRuleNOTCompleteSeries" was Processed for the TargetSeries $associatedTargetSeries
		Log that this Series Rule fired for the Series $associatedTargetSeries
end

/*************************************************************************************************************************************************************************************
 END __SKIP DOSE__ Logic for patients < 5 yrs Series for Series: Pfizer < 5yrs, Moderna < 5yrs
/************************************************************************************************************************************************************************************/

//////////////////////////////////////////////////////////////////////////////////////////////////
// END Fall 2023-2024 Season
//////////////////////////////////////////////////////////////////////////////////////////////////
